<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Product Dashboard</title>
    
    <link rel="icon" href="https://raw.githubusercontent.com/YashShah20F/Dashboard-V3/main/favicon%20BW.png" type="image/png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-45WZTRG841"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-45WZTRG841');
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        
        :root {
            /* Dark Mode (Midnight) */
            --bg-color: #1a1b1e;
            --text-color: #f0f0f0;
            --text-muted-color: #9a9a9e;
            --card-bg: rgba(44, 44, 46, 0.7);
            --card-border: rgba(255, 255, 255, 0.15);
            --card-hover-bg: rgba(58, 58, 60, 0.8);
            --card-hover-shadow: 0 20px 40px -10px rgba(0,0,0,0.4);
            --header-bg: rgba(28, 28, 30, 0.7);
            --header-border: rgba(255, 255, 255, 0.15);
            --icon-color: #ffffff;
            --nav-text-color: #9a9a9e;
            --nav-text-hover: #ffffff;
            --nav-active-bg: rgba(255, 255, 255, 0.1);
            --nav-active-text: #ffffff;
            --sub-box-bg: rgba(28, 28, 30, 0.5);
            --footer-bg: #1c1c1e;
            --chart-grid-color: rgba(255, 255, 255, 0.1);
            --chart-tick-color: #9a9a9e;
            --good-tint: rgba(48, 209, 88, 0.15);
            --medium-tint: rgba(255, 159, 10, 0.15);
            --bad-tint: rgba(255, 69, 58, 0.15);
            --bar-track-bg: rgba(55, 55, 57, 0.8);
        }

        body.light-mode {
            /* Graphite Theme */
            --bg-color: #e5e5ea;
            --text-color: #1c1c1e;
            --text-muted-color: #3a3a3c;
            --card-bg: rgba(242, 242, 247, 0.7);
            --card-border: rgba(0, 0, 0, 0.08);
            --card-hover-bg: rgba(255, 255, 255, 0.8);
            --card-hover-shadow: 0 20px 40px -10px rgba(0,0,0,0.2);
            --header-bg: rgba(235, 235, 240, 0.75);
            --header-border: rgba(0, 0, 0, 0.09);
            --icon-color: #1c1c1e;
            --nav-text-color: #555555;
            --nav-text-hover: #000000;
            --nav-active-bg: #ffffff;
            --nav-active-text: #000000;
            --sub-box-bg: rgba(229, 229, 234, 0.75);
            --footer-bg: transparent;
            --chart-grid-color: rgba(0, 0, 0, 0.08);
            --chart-tick-color: #8d8d92;
            --good-tint: rgba(48, 209, 88, 0.25);
            --medium-tint: rgba(255, 159, 10, 0.25);
            --bad-tint: rgba(255, 69, 58, 0.25);
            --bar-track-bg: rgba(0, 0, 0, 0.06);
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.5s ease, color 0.5s ease;
        }
        
        .main-content::-webkit-scrollbar { width: 8px; }
        .main-content::-webkit-scrollbar-track { background: transparent; }
        .main-content::-webkit-scrollbar-thumb {
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }
        body:not(.light-mode) .main-content::-webkit-scrollbar-thumb {
            background-color: rgba(255, 255, 255, 0.2);
        }
        .hidden { display: none; }
        .fa-sync-alt.animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        #loading-overlay {
            transition: opacity 0.5s ease-in-out;
        }
        
        #loading-text-container span {
            opacity: 0;
            animation: fadeInOut 2s ease-in-out infinite;
            font-size: 1.25rem;
            font-weight: 500;
            color: var(--text-muted-color);
        }
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }
        #navigation-bar { max-width: 48rem; }
        .nav-item {
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            color: var(--nav-text-color);
            border-radius: 9999px;
        }
        .nav-item:hover {
            color: var(--nav-text-hover);
            background-color: rgba(255, 255, 255, 0.05);
        }
        body.light-mode .nav-item:hover { background-color: rgba(0, 0, 0, 0.04); }
        
        /* Glassy iOS Active State */
        .nav-item.active {
            color: var(--nav-active-text);
            background-color: var(--nav-active-bg);
        }
        body.light-mode .nav-item.active {
            box-shadow: 0 1px 2px rgba(0,0,0,0.05), inset 0 1px 2px rgba(255,255,255,0.7);
            background-image: linear-gradient(to bottom, rgba(255,255,255,0.5), rgba(255,255,255,0.1));
            border: 1px solid rgba(0,0,0,0.08);
        }
        body:not(.light-mode) .nav-item.active {
             box-shadow: 0 4px 15px rgba(0,0,0,0.25);
             background-image: linear-gradient(to bottom, rgba(255,255,255,0.15), rgba(255,255,255,0.1));
        }

        .metric-card, .sub-box { 
            border-radius: 1.5rem; 
            transition: all 0.3s ease; 
            border: 1px solid var(--card-border); 
            background-color: var(--card-bg); 
            backdrop-filter: blur(20px); 
        }
        body.light-mode .metric-card, body.light-mode .sub-box {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.07);
        }

        .sub-box:hover, .small-metric-card:hover {
            transform: translateY(-4px) scale(1.03);
            box-shadow: var(--card-hover-shadow);
        }
        body.light-mode .sub-box:hover, body.light-mode .small-metric-card:hover { border-color: rgba(0, 0, 0, 0.1); }
        body:not(.light-mode) .sub-box:hover, body:not(.light-mode) .small-metric-card:hover { border-color: rgba(255, 255, 255, 0.2); }
        
        .metric-card.no-hover-pop:hover, .sub-box.no-hover-pop:hover {
            transform: none;
            box-shadow: none;
        }
        body.light-mode .metric-card.no-hover-pop:hover, body.light-mode .sub-box.no-hover-pop:hover {
            border-color: rgba(0, 0, 0, 0.08);
        }
        body:not(.light-mode) .metric-card.no-hover-pop:hover, body:not(.light-mode) .sub-box.no-hover-pop:hover {
            border-color: rgba(255, 255, 255, 0.1);
        }

        .metric-value { transition: transform 0.3s ease; }
        .sub-box:hover .metric-value, .small-metric-card:hover .metric-value { transform: scale(1.1); }
        
        .metric-card[data-color-state="good"], 
        .sub-box[data-color-state="good"],
        .qrf-scorecard[data-color-state="good"],
        .rating-scale-card[data-color-state="good"],
        .scorecard[data-state="good"] { 
            background-color: var(--good-tint); 
        }
        .metric-card[data-color-state="medium"],
        .sub-box[data-color-state="medium"],
        .qrf-scorecard[data-color-state="medium"],
        .rating-scale-card[data-color-state="medium"],
        .scorecard[data-state="medium"] { 
            background-color: var(--medium-tint); 
        }
        .metric-card[data-color-state="bad"],
        .sub-box[data-color-state="bad"],
        .qrf-scorecard[data-color-state="bad"],
        .rating-scale-card[data-color-state="bad"],
        .scorecard[data-state="bad"] { 
            background-color: var(--bad-tint); 
        }
        
        .qrf-scorecard, .rating-scale-card { transition: all 0.3s ease; }
        .qrf-scorecard .value, .rating-scale-card .value { transition: transform 0.3s ease; }
        .qrf-scorecard:hover, .rating-scale-card:hover { transform: translateY(-4px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        body:not(.light-mode) .qrf-scorecard:hover, body:not(.light-mode) .rating-scale-card:hover { box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .qrf-scorecard:hover .value, .rating-scale-card:hover .value { transform: scale(1.05); }
        .pie-legend-item { transition: all 0.2s ease-in-out; }
        .pie-legend-item:hover {
            transform: scale(1.05);
            background-color: var(--card-hover-bg);
        }
        .split-box { transition: all 0.3s ease; }
        .split-box:hover {
            transform: translateY(-4px) scale(1.03);
            background-color: var(--card-hover-bg);
            box-shadow: var(--card-hover-shadow);
        }
        .split-box .split-value { transition: transform 0.3s ease; }
        .split-box:hover .split-value {
            transform: scale(1.1);
        }
        
        /* Timeline Toggle Glassy Redesign */
        .timeline-toggle {
            transition: all 0.2s ease-in-out;
        }
        .timeline-toggle .timeline-btn { 
            transition: all 0.2s ease-in-out;
            transform: scale(1);
        }
        .timeline-toggle .timeline-btn.active {
            transform: scale(1.05);
        }
        body.light-mode .timeline-toggle .timeline-btn.active {
            background-color: var(--nav-active-bg);
            color: var(--nav-active-text);
            box-shadow: 0 1px 2px rgba(0,0,0,0.05), inset 0 1px 2px rgba(255,255,255,0.7);
            background-image: linear-gradient(to bottom, rgba(255,255,255,0.5), rgba(255,255,255,0.1));
            border: 1px solid rgba(0,0,0,0.08);
        }
        body:not(.light-mode) .timeline-toggle .timeline-btn.active {
            background-color: var(--text-color);
            color: var(--bg-color);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .timeline-toggle .timeline-btn:not(.active):hover {
            transform: translateY(-2px) scale(1.02);
            background-color: rgba(255, 255, 255, 0.1);
        }
        body.light-mode .timeline-toggle .timeline-btn:not(.active):hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        /* Open Sheet Button Animation */
        #open-sheet-button {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #open-sheet-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            background-color: #109c59;
            color: white;
            border-color: #109c59;
        }
        body:not(.light-mode) #open-sheet-button:hover {
             box-shadow: 0 8px 20px rgba(16, 156, 89, 0.3);
        }
        #open-sheet-button:hover span {
            color: white !important;
        }
        #open-sheet-button:hover i {
            color: white !important;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer {
            0% { opacity: 0.7; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.1); }
            100% { opacity: 0.7; transform: scale(1); }
        }


        #page-footer {
            background-color: var(--footer-bg);
            color: var(--text-muted-color);
            padding: 1.5rem;
            text-align: center;
            font-size: 0.9rem;
            width: 100%;
            flex-shrink: 0;
            opacity: 0;
            transition: opacity 0.5s ease;
            pointer-events: none;
        }
        #page-footer.visible {
            opacity: 1;
            pointer-events: auto;
        }

        /* Bar Chart Styles */
        .bar-chart-row { display: flex; align-items: center; gap: 0.75rem; width: 100%; border-radius: 0.5rem; }
        .bar-chart-label { flex-shrink: 0; width: 5rem; text-align: right; font-size: 0.875rem; color: var(--text-muted-color); }
        .bar-chart-bar-container { flex-grow: 1; background-color: var(--bar-track-bg); border-radius: 9999px; height: 1.75rem; position: relative; overflow: hidden; }
        .bar-chart-bar { position: absolute; left: 0; top: 0; height: 100%; border-radius: 9999px; background-color: var(--text-muted-color); transition: width 0.8s cubic-bezier(0.25, 1, 0.5, 1), background-color 0.3s ease; width: 0; }
        .bar-chart-bar.animate-in { width: var(--target-width); }
        .bar-chart-bar.good { background-color: #34c759; }
        .bar-chart-bar.medium { background-color: #ff9500; }
        .bar-chart-bar.bad { background-color: #ff3b30; }
        .bar-chart-value { font-weight: 600; color: var(--text-color); width: 4rem; text-align: left; }
        
        /* Rating Scale Styles */
        .rating-scale-container { width: 100%; }
        .rating-scale-track { height: 0.75rem; background-color: var(--sub-box-bg); border-radius: 9999px; overflow: hidden; position: relative; }
        .rating-scale-fill { height: 100%; border-radius: 9999px; transition: width 0.8s cubic-bezier(0.25, 1, 0.5, 1); width: 0; }
        .rating-scale-fill.animate-in { width: var(--target-width); }
        .rating-scale-fill.good { background: linear-gradient(90deg, #34c759, #30d158); }
        .rating-scale-fill.medium { background: linear-gradient(90deg, #ff9500, #ff9f0a); }
        .rating-scale-fill.bad { background: linear-gradient(90deg, #ff3b30, #ff453a); }

        /* --- Final Report Tile Design --- */
        .report-tile {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--card-border);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        .report-tile:hover {
            transform: translateY(-8px) scale(1.05);
            background: var(--card-hover-bg);
            box-shadow: var(--card-hover-shadow);
        }
        .report-tile::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                135deg,
                rgba(255, 255, 255, 0.2) 0%,
                rgba(255, 255, 255, 0) 60%
            );
            transform: translateX(-100%);
            transition: transform 0.6s ease;
            opacity: 0.6;
        }
        body:not(.light-mode) .report-tile::before {
            opacity: 0.3;
        }
        .report-tile:hover::before {
            transform: translateX(100%);
        }
        .report-tile-icon {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: var(--icon-color);
        }
        .report-tile:hover .report-tile-icon {
            transform: scale(1.1);
        }
        body:not(.light-mode) .report-tile:hover {
            border-color: rgba(255,255,255,0.2);
        }
        
        /* --- Support Scorecard --- */
        .scorecard {
            background-color: var(--sub-box-bg);
            border: 1px solid rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }
        .scorecard:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        /* --- Passcode Screen Styles --- */
        #passcode-overlay { backdrop-filter: blur(20px); transition: opacity 0.5s ease-in-out; }
        #passcode-container { transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out; }
        .passcode-dot { width: 1rem; height: 1rem; border-radius: 9999px; border: 2px solid var(--text-muted-color); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .passcode-dot.filled { background-color: var(--text-color); border-color: var(--text-color); transform: scale(1.1); }
        .passcode-dot.success { background-color: #22c55e; border-color: #22c55e; animation: pulse 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        #passcode-dots.shake { animation: shake 0.6s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translateX(-1px); } 20%, 80% { transform: translateX(2px); } 30%, 50%, 70% { transform: translateX(-4px); } 40%, 60% { transform: translateX(4px); } }
        @keyframes pulse { 0%, 100% { transform: scale(1.1); } 50% { transform: scale(1.3); } }
        .passcode-keypad-btn { background-color: rgba(128, 128, 128, 0.2); color: var(--text-color); transition: all 0.2s ease-in-out; border: none; touch-action: manipulation; }
        .passcode-keypad-btn:active { background-color: rgba(255, 255, 255, 0.3); transform: scale(0.95); }
        body.light-mode .passcode-keypad-btn { background-color: rgba(0, 0, 0, 0.1); }
        body.light-mode .passcode-keypad-btn:active { background-color: rgba(0, 0, 0, 0.2); }

        /* NEW ATTENDANCE STYLES */
        .product-rank-item { display: flex; align-items: center; gap: 1rem; padding: 1rem; transition: all 0.3s ease; background-color: var(--sub-box-bg); border-radius: 1.25rem; }
        .product-rank-item:hover { transform: translateY(-4px); box-shadow: var(--card-hover-shadow); }
        .product-rank-item:hover[data-color-state="good"] { background-image: linear-gradient(to right, rgba(48, 209, 88, 0.2), rgba(48, 209, 88, 0.05)); }
        .product-rank-item:hover[data-color-state="medium"] { background-image: linear-gradient(to right, rgba(255, 159, 10, 0.2), rgba(255, 159, 10, 0.05)); }
        .product-rank-item:hover[data-color-state="bad"] { background-image: linear-gradient(to right, rgba(255, 69, 58, 0.2), rgba(255, 69, 58, 0.05)); }
        .product-rank-number { font-size: 2.5rem; font-weight: 800; line-height: 1; color: var(--text-muted-color); width: 4rem; text-align: center; }
        .product-rank-details { flex-grow: 1; }
        .attendance-student-list { max-height: 400px; overflow-y: auto; padding-right: 0.5rem; }
        .attendance-student-list::-webkit-scrollbar { width: 6px; }
        .attendance-student-list::-webkit-scrollbar-track { background: transparent; }
        .attendance-student-list::-webkit-scrollbar-thumb { background-color: rgba(0, 0, 0, 0.2); border-radius: 6px; }
        body:not(.light-mode) .attendance-student-list::-webkit-scrollbar-thumb { background-color: rgba(255, 255, 255, 0.2); }
        .custom-select-wrapper { position: relative; display: inline-block; }
        .custom-select { -webkit-appearance: none; -moz-appearance: none; appearance: none; background-color: var(--sub-box-bg); border: 1px solid var(--card-border); color: var(--text-color); padding: 0.75rem 2.5rem 0.75rem 1rem; border-radius: 0.75rem; cursor: pointer; transition: all 0.2s ease; width: 100%; }
        .custom-select:hover { background-color: var(--card-hover-bg); }
        .custom-select-wrapper::after { content: '\f078'; font-family: 'Font Awesome 6 Free'; font-weight: 900; position: absolute; top: 50%; right: 1rem; transform: translateY(-50%); pointer-events: none; color: var(--text-muted-color); }

        @media (max-width: 768px) {
            #passcode-overlay { justify-content: flex-end; padding-bottom: 5vh; }
            .header-container { min-height: 3.5rem; }
            #main-header, #page-header { justify-content: space-between; gap: 0.5rem; }
            #page-header-center-content { position: absolute; left: 50%; transform: translateX(-50%); width: auto; max-width: calc(100% - 8rem); }
            #page-header-title { font-size: 1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
            #navigation-bar { width: 100%; }
            .nav-item { padding: 0.75rem 0.5rem; font-size: 0.8rem; flex-grow: 1; text-align: center; }
            #theme-toggle, #main-header-refresh-button { width: 2.75rem; height: 2.75rem; flex-shrink: 0; }
            #theme-toggle > i { font-size: 1rem; }
            .page-content { padding-top: 1rem; }
            .card-grid { flex-direction: column; }
            .sub-box .card-grid.force-row { flex-direction: row; flex-wrap: nowrap; }
            .card-grid .flex-grow { min-width: 0; }
            #header-greeting { display: none; }
            .report-tile h3 { font-size: 1.1rem; }
        }
    </style>
</head>
<body class="h-screen flex flex-col">
    <!-- Passcode Screen -->
    <div id="passcode-overlay" class="fixed inset-0 bg-[var(--bg-color)]/80 flex flex-col items-center justify-center z-[101]">
        <div id="passcode-container" class="flex flex-col items-center">
            <div class="text-center">
                <h2 class="text-2xl font-semibold text-[var(--text-color)] mb-2">Zell Product Dashboard</h2>
                <p class="text-sm text-[var(--text-muted-color)] mb-6">Enter Passcode</p>
                <div id="passcode-dots" class="flex justify-center items-center gap-4 mb-4">
                    <div class="passcode-dot"></div>
                    <div class="passcode-dot"></div>
                    <div class="passcode-dot"></div>
                    <div class="passcode-dot"></div>
                </div>
                <p id="passcode-error" class="text-red-500 h-6"></p>
            </div>
            <div id="passcode-keypad" class="grid grid-cols-3 gap-4 mt-8 max-w-xs w-full">
                <button data-key="1" class="passcode-keypad-btn text-3xl font-light rounded-full aspect-square flex items-center justify-center">1</button>
                <button data-key="2" class="passcode-keypad-btn text-3xl font-light rounded-full aspect-square flex items-center justify-center">2</button>
                <button data-key="3" class="passcode-keypad-btn text-3xl font-light rounded-full aspect-square flex items-center justify-center">3</button>
                <button data-key="4" class="passcode-keypad-btn text-3xl font-light rounded-full aspect-square flex items-center justify-center">4</button>
                <button data-key="5" class="passcode-keypad-btn text-3xl font-light rounded-full aspect-square flex items-center justify-center">5</button>
                <button data-key="6" class="passcode-keypad-btn text-3xl font-light rounded-full aspect-square flex items-center justify-center">6</button>
                <button data-key="7" class="passcode-keypad-btn text-3xl font-light rounded-full aspect-square flex items-center justify-center">7</button>
                <button data-key="8" class="passcode-keypad-btn text-3xl font-light rounded-full aspect-square flex items-center justify-center">8</button>
                <button data-key="9" class="passcode-keypad-btn text-3xl font-light rounded-full aspect-square flex items-center justify-center">9</button>
                <div class="aspect-square"></div>
                <button data-key="0" class="passcode-keypad-btn text-3xl font-light rounded-full aspect-square flex items-center justify-center">0</button>
                <button data-key="backspace" class="passcode-keypad-btn rounded-full aspect-square flex items-center justify-center text-2xl">
                    <i class="fas fa-delete-left"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-[var(--bg-color)] flex items-center justify-center z-[100] opacity-0 pointer-events-none">
        <div id="loading-text-container">
            <span>Loading...</span>
        </div>
    </div>

    <!-- Header -->
    <header class="w-full z-50 p-2 md:p-4 flex-shrink-0 hidden">
        <div class="w-full max-w-7xl mx-auto flex items-center header-container relative h-full">
            
            <!-- Main Header for Overview/Reports List -->
            <div id="main-header" class="w-full h-full flex items-center justify-between md:justify-center relative">
                <div class="flex-1 flex justify-start">
                    <div id="header-greeting" class="hidden md:block opacity-0 transition-opacity duration-500">
                        <h2 id="greeting-text" class="text-xl font-bold text-[var(--text-color)] whitespace-nowrap"></h2>
                        <p id="date-text" class="text-sm text-[var(--text-muted-color)] whitespace-nowrap"></p>
                    </div>
                    <button id="theme-toggle-mobile" class="md:hidden bg-[var(--card-bg)] border border-[var(--header-border)] text-[var(--nav-text-color)] hover:text-[var(--nav-text-hover)] w-12 h-12 rounded-full flex items-center justify-center transition-all duration-300 hover:bg-white/10">
                        <i class="fas fa-sun"></i>
                    </button>
                </div>

                <div class="flex-shrink-0 mx-2 md:mx-4">
                     <nav id="navigation-bar" class="bg-[var(--header-bg)] backdrop-blur-lg border border-[var(--header-border)] rounded-full p-2 flex justify-center items-center gap-1">
                          <button data-tab="overview" class="nav-item">Overview</button>
                          <button data-tab="reports" class="nav-item">Reports</button>
                          <button id="theme-toggle-desktop" class="hidden md:flex px-4 py-3 rounded-full text-lg transition-all duration-300 text-[var(--nav-text-color)] hover:text-[var(--nav-text-hover)]">
                               <i class="fas fa-sun"></i>
                          </button>
                     </nav>
                </div>

                <div class="flex-1 flex justify-end items-center gap-2">
                     <button id="main-header-refresh-button" class="bg-[var(--card-bg)] border border-[var(--header-border)] text-[var(--nav-text-color)] hover:text-[var(--nav-text-hover)] w-12 h-12 rounded-full flex items-center justify-center transition-all duration-300 hover:bg-white/10">
                          <i class="fas fa-sync-alt"></i>
                     </button>
                </div>
            </div>

            <!-- Page-specific Header -->
            <div id="page-header" class="hidden w-full h-full items-center justify-center relative">
                <div class="absolute left-0 top-1/2 -translate-y-1/2">
                    <button id="header-back-button" class="bg-[var(--card-bg)] border border-[var(--header-border)] text-[var(--nav-text-color)] hover:text-[var(--nav-text-hover)] w-12 h-12 rounded-full flex items-center justify-center transition-all duration-300 hover:bg-white/10">
                        <i class="fas fa-chevron-left text-xl"></i>
                    </button>
                </div>
                <div id="page-header-center-content" class="bg-[var(--header-bg)] backdrop-blur-lg border border-[var(--header-border)] rounded-full flex items-center justify-center px-4 md:px-8 py-3 mx-auto">
                    <h1 id="page-header-title" class="text-xl md:text-2xl font-bold text-[var(--text-color)]"></h1>
                </div>
                <div class="absolute right-0 top-1/2 -translate-y-1/2 flex items-center gap-2">
                    <button id="header-refresh-button" class="bg-[var(--card-bg)] border border-[var(--header-border)] text-[var(--nav-text-color)] hover:text-[var(--nav-text-hover)] w-12 h-12 rounded-full flex items-center justify-center transition-all duration-300 hover:bg-white/10 hidden">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <a id="open-sheet-button" href="#" target="_blank" rel="noopener noreferrer" class="bg-[var(--card-bg)] border border-[var(--header-border)] text-[var(--nav-text-color)] w-12 h-12 md:h-12 md:w-auto md:px-5 rounded-full flex items-center justify-center">
                        <span class="mr-2 hidden md:inline">Open Sheet</span>
                        <i class="fas fa-external-link-alt"></i>
                    </a>
                </div>
            </div>
        </div>
    </header>
    
    <!-- Main Content Area -->
    <main id="main-content" class="flex-grow overflow-y-auto w-full max-w-7xl mx-auto px-4 md:px-8 pb-8 main-content relative">
        <div id="overview-section" class="page-content pt-8 pb-16"></div>
        <div id="daily-section" class="page-content hidden pt-8 pb-16"></div>
        <div id="reports-section" class="page-content hidden pt-8 pb-16"></div>
        <div id="question-repo-section" class="page-content hidden pt-8 pb-16"></div>
        <div id="course-checks-section" class="page-content hidden pt-8 pb-16"></div>
        <div id="batch-reports-section" class="page-content hidden pt-8 pb-16"></div>
        <div id="ask-a-doubt-section" class="page-content hidden pt-8 pb-16"></div>
        <div id="attendance-section" class="page-content hidden pt-8 pb-16"></div>
        
        <footer id="page-footer">
            <div id="footer-content" class="text-center"></div>
        </footer>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Configuration ---
            const API_URL = "https://script.google.com/macros/s/AKfycbw3af1hFqZ-P9rxaWw4P7eUY47yHC1Iz6lWlHL3PkMRGDSGA3Kmoiy18v5aoaF3MBRjwg/exec";
            const CORRECT_PASSCODE = '2020';
            const SHEET_URLS = {
                'daily-section': 'https://docs.google.com/spreadsheets/d/17_clxpnwRjQ7qEiR6taISN9eLblZQ-4fr9WB2EqyQeE/edit?usp=sharing',
                'course-checks-section': 'https://docs.google.com/spreadsheets/d/1nvGEbgEfrVrW1zWGndsRjF2naOp24BRk0cCRlLBoing/edit?usp=sharing',
                'question-repo-section': 'https://docs.google.com/spreadsheets/d/195XkhREyrh329AtiWItixWUm-J019vf7NzKyCBQvIYw/edit?usp=sharing',
                'ask-a-doubt-section': 'https://docs.google.com/spreadsheets/d/101pxzW4-A1nuoazXwWi0XFx61iLc9QhcRA-8AbkW2UM/edit?usp=sharing',
                'batch-reports-section': 'https://docs.google.com/spreadsheets/d/1QjRDyvdsDLTqo2wVuv9nF125z7nxaN2htTh-3o5HQ8A/edit?usp=sharing',
                'attendance-section': 'https://docs.google.com/spreadsheets/d/1_attendance_sheet_url_placeholder/edit?usp=sharing' // Placeholder URL
            };

            // --- State Management ---
            const dataCache = {};
            let chartInstances = {};

            // --- DOM Elements ---
            const mainContent = document.getElementById('main-content');
            const navButtons = document.querySelectorAll('.nav-item');
            const pageContents = document.querySelectorAll('.page-content');
            const header = document.querySelector('header');
            const mainHeader = document.getElementById('main-header');
            const headerBackButton = document.getElementById('header-back-button');
            const pageHeader = document.getElementById('page-header');
            const pageHeaderCenterContent = document.getElementById('page-header-center-content');
            const openSheetButton = document.getElementById('open-sheet-button');
            const headerRefreshButton = document.getElementById('header-refresh-button');
            const mainHeaderRefreshButton = document.getElementById('main-header-refresh-button');
            const themeToggleDesktop = document.getElementById('theme-toggle-desktop');
            const themeToggleMobile = document.getElementById('theme-toggle-mobile');
            const loadingOverlay = document.getElementById('loading-overlay');
            const passcodeOverlay = document.getElementById('passcode-overlay');
            const passcodeContainer = document.getElementById('passcode-container');
            const passcodeKeypad = document.getElementById('passcode-keypad');
            const passcodeDots = document.getElementById('passcode-dots');
            const passcodeError = document.getElementById('passcode-error');
            const headerGreeting = document.getElementById('header-greeting');

            // --- Data Fetching & Processing ---
            async function fetchAllData(forceRefresh = false) {
                if (Object.keys(dataCache).length > 0 && !forceRefresh) {
                    console.log("Using cached data.");
                    return dataCache;
                }
                console.log("Fetching new data from API...");

                const MAX_RETRIES = 3;
                const INITIAL_RETRY_DELAY = 3000;

                for (let attempt = 1; attempt <= MAX_RETRIES; attempt++) {
                    try {
                        const response = await fetch(API_URL);
                        if (!response.ok) throw new Error(`API responded with status: ${response.status}`);
                        
                        const data = await response.json();
                        if (data.error) throw new Error(`API script returned an error: ${data.details || data.error}`);

                        const batchInfoData = data.batch_information;
                        const keyMetricValue = (batchInfoData && batchInfoData[0] && batchInfoData[0][1] != null) ? String(batchInfoData[0][1]) : '';
                        const isBatchInfoInvalid = !batchInfoData || batchInfoData.length === 0 || keyMetricValue === '' || keyMetricValue.includes('#REF!') || keyMetricValue.includes('#NAME?');

                        if (isBatchInfoInvalid) {
                            if (attempt < MAX_RETRIES) {
                                const delay = INITIAL_RETRY_DELAY * attempt;
                                console.warn(`Batch information is invalid (Attempt ${attempt}/${MAX_RETRIES}). Retrying in ${delay / 1000}s...`);
                                await new Promise(resolve => setTimeout(resolve, delay));
                                continue;
                            } else {
                                console.warn('Batch information failed to load after multiple retries. The section will show an error message.');
                                data.batch_information = null;
                            }
                        }
                        
                        Object.keys(dataCache).forEach(key => delete dataCache[key]);
                        Object.assign(dataCache, data);
                        console.log("Data fetched and cached:", dataCache);
                        return dataCache;

                    } catch (error) {
                        console.error(`Fetch attempt ${attempt} failed:`, error);
                        if (attempt === MAX_RETRIES) {
                            mainContent.innerHTML = `<div class="bg-red-900/50 border border-[var(--card-border)] text-red-200 px-6 py-4 rounded-xl text-center max-w-2xl mx-auto mt-8"><h3 class="font-bold text-lg mb-2">Data Loading Error</h3><p>${error.message}</p></div>`;
                            return null;
                        }
                    }
                }
                return null;
            }

            function parseAsHeaders(dataArray) {
                 if (!dataArray || !Array.isArray(dataArray) || dataArray.length < 1) return [];
                let headerRowIndex = -1;
                for(let i = 0; i < dataArray.length; i++) {
                    if(Array.isArray(dataArray[i]) && dataArray[i].some(cell => cell !== null && cell !== '')) {
                        headerRowIndex = i;
                        break;
                    }
                }
                if(headerRowIndex === -1) return [];
                const headers = dataArray[headerRowIndex].map(h => String(h).trim());
                const dataRows = dataArray.slice(headerRowIndex + 1);
                return dataRows.map(row => {
                    if(Array.isArray(row) && row.some(cell => cell !== null && cell !== '')) {
                        const obj = {};
                        headers.forEach((header, index) => {
                            if (header) obj[header] = row[index];
                        });
                        return obj;
                    }
                    return null;
                }).filter(Boolean);
            }

            // --- UI Helpers ---
            const getIconForMetric = (label) => {
                const lowerLabel = String(label).toLowerCase();
                if (lowerLabel.includes('enrolled') || lowerLabel.includes('learners')) return 'fas fa-user-graduate';
                if (lowerLabel.includes('attendance')) return 'fas fa-user-check';
                if (lowerLabel.includes('lps')) return 'fas fa-chart-line';
                if (lowerLabel.includes('qc batches')) return 'fas fa-clipboard-check';
                if (lowerLabel.includes('dau')) return 'fas fa-users';
                if (lowerLabel.includes('mau')) return 'fas fa-calendar-week';
                if (lowerLabel.includes('web')) return 'fas fa-globe';
                if (lowerLabel.includes('android')) return 'fab fa-android';
                if (lowerLabel.includes('ios')) return 'fab fa-apple';
                if (lowerLabel.includes('rating')) return 'fas fa-star';
                if (lowerLabel.includes('doubt')) return 'fas fa-question-circle';
                if (lowerLabel.includes('ticket')) return 'fas fa-ticket-alt';
                if (lowerLabel.includes('batch')) return 'fas fa-chalkboard-teacher';
                if (lowerLabel.includes('user')) return 'fas fa-user-friends';
                if (lowerLabel.includes('tests')) return 'fas fa-tasks';
                if (lowerLabel.includes('time')) return 'fas fa-clock';
                return 'fas fa-chart-bar';
            };

            const showLoading = (container) => { container.innerHTML = `<div class="flex justify-center items-center h-64"><div class="w-16 h-16 border-4 border-[var(--text-muted-color)] border-t-[var(--text-color)] rounded-full animate-spin"></div></div>`; };
            const showError = (container, message) => { container.innerHTML = `<div class="bg-red-900/50 border border-[var(--card-border)] text-red-200 px-6 py-4 rounded-xl text-center max-w-2xl mx-auto"><h3 class="font-bold text-lg mb-2">Error Loading Data</h3><p>${message}</p></div>`; };
            
            const getPerformanceColorState = (labelOrValue, valueStr) => {
                const value = parseFloat(valueStr !== undefined ? valueStr : labelOrValue);
                if (isNaN(value)) return 'neutral';
                
                let thresholds = { bad: 35, medium: 70 };
                if (typeof labelOrValue === 'string' && labelOrValue.includes('LPS')) {
                    thresholds = { bad: 35, medium: 75 };
                }
                if (value <= thresholds.bad) return 'bad';
                if (value > thresholds.bad && value <= thresholds.medium) return 'medium';
                return 'good';
            };
            
            const getPerformanceColorClass = (state) => {
                if (state === 'bad') return 'text-red-500';
                if (state === 'medium') return 'text-amber-500';
                if (state === 'good') return 'text-green-500';
                return 'text-[var(--text-color)]';
            };

            const triggerAnimations = (container) => {
                setTimeout(() => {
                    container.querySelectorAll('.bar-chart-bar').forEach(bar => {
                        bar.classList.add('animate-in');
                    });
                    container.querySelectorAll('.rating-scale-fill').forEach(fill => {
                        fill.classList.add('animate-in');
                    });
                }, 100);
            };

            // --- UI Component Generators ---
            const createSupportScorecard = (title, openData, totalData) => {
                const openValue = openData.value;
                let state = 'medium';
                let iconClass = 'fa-minus';
                let colorClass = 'text-amber-600';

                if (openValue >= 10) { state = 'bad'; iconClass = 'fa-arrow-up'; colorClass = 'text-red-600'; } 
                else if (openValue < 5) { state = 'good'; iconClass = 'fa-arrow-down'; colorClass = 'text-green-600'; }

                return `<div class="scorecard rounded-3xl p-6 flex flex-col text-center" data-state="${state}"><h3 class="font-semibold text-lg" style="color: var(--text-color);">${title}</h3><div class="flex-grow flex items-center justify-center py-4"><div class="flex items-end gap-3"><p class="text-6xl font-bold tracking-tight" style="color: var(--text-color);">${openValue}</p><div class="text-3xl ${colorClass} mb-1"><i class="fas ${iconClass}"></i></div></div></div><p class="text-sm font-medium" style="color: var(--text-muted-color);">${totalData.label}: ${new Intl.NumberFormat('en-US').format(totalData.value)}</p></div>`;
            };

            const createBarChartCard = (title, data) => {
                const numberFormatter = new Intl.NumberFormat('en-US');
                const maxValue = Math.max(...data.map(d => d.value), 1);
                const rowsHtml = data.map(item => `<div class="bar-chart-row p-1 rounded-lg"><div class="bar-chart-label">${item.label}</div><div class="bar-chart-bar-container"><div class="bar-chart-bar" style="--target-width: ${ (item.value / maxValue) * 100 }%;"></div></div><div class="bar-chart-value">${numberFormatter.format(item.value)}</div></div>`).join('');
                return `<div class="sub-box bg-[var(--sub-box-bg)] p-4 md:p-6 rounded-2xl border border-[var(--card-border)] flex flex-col h-full"><h3 class="text-lg md:text-xl font-bold text-[var(--text-color)] opacity-90 mb-4 text-center">${title}</h3><div class="space-y-3 mt-auto">${rowsHtml}</div></div>`;
            };

            const createRatingScaleCard = (title, icon, rating, totalRatings) => {
                const ratingValue = parseFloat(rating) || 0;
                const totalRatingsValue = parseInt(String(totalRatings).replace(/,/g, ''), 10) || 0;
                let colorState = ratingValue >= 4.0 ? 'good' : ratingValue >= 3.5 ? 'medium' : 'bad';
                return `<div class="rating-scale-card bg-[var(--sub-box-bg)] p-6 rounded-2xl border border-[var(--card-border)] space-y-4" data-color-state="${colorState}"><h4 class="text-lg font-semibold text-center text-[var(--text-muted-color)] flex items-center justify-center gap-2"><i class="${icon}"></i>${title}</h4><div class="flex items-center gap-4"><span class="font-bold text-2xl text-[var(--text-color)]">${ratingValue.toFixed(1)}</span><div class="rating-scale-container"><div class="rating-scale-track"><div class="rating-scale-fill ${colorState}" style="--target-width: ${(ratingValue / 5) * 100}%;"></div></div></div></div><p class="text-center text-sm text-[var(--text-muted-color)] -mt-1">${new Intl.NumberFormat('en-US').format(totalRatingsValue)} Ratings</p></div>`;
            };

            // --- Page Rendering Functions ---
            const renderOverviewPage = (container, allData) => {
                if (!allData || !allData.daily_metrics || !allData.aad_lms_tickets) { showError(container, "Could not load all necessary data for the overview."); return; }
                const dailyMetrics = allData.daily_metrics, batchInfoData = allData.batch_information, supportInfo = allData.aad_lms_tickets;
                const getCellValue = (data, row, col) => { const val = (data && data[row] && data[row][col] != null) ? data[row][col] : '--'; const valStr = String(val); return (valStr.includes('#REF!') || valStr.includes('#NAME?')) ? '--' : val; };
                const parseNumeric = (val) => (val === '--' || val == null) ? 0 : parseInt(String(val).replace(/,/g, ''), 10) || 0;
                const batchInfo = batchInfoData ? { 'Total enrolled students': getCellValue(batchInfoData, 0, 1), 'Live batches count': getCellValue(batchInfoData, 1, 1), 'Average Attendance %': getCellValue(batchInfoData, 2, 1), 'Average LPS': getCellValue(batchInfoData, 3, 1), 'Test Completion %': getCellValue(batchInfoData, 4, 1) } : null;
                const dauData = [{ label: 'Web', value: parseNumeric(getCellValue(dailyMetrics, 5, 1)) }, { label: 'Android', value: parseNumeric(getCellValue(dailyMetrics, 5, 2)) }, { label: 'iOS', value: parseNumeric(getCellValue(dailyMetrics, 5, 3)) }];
                const mauData = [{ label: 'Web', value: parseNumeric(getCellValue(dailyMetrics, 6, 1)) }, { label: 'Android', value: parseNumeric(getCellValue(dailyMetrics, 6, 2)) }, { label: 'iOS', value: parseNumeric(getCellValue(dailyMetrics, 6, 3)) }];
                const userAnalyticsContent = createBarChartCard('Daily Active Users (DAU)', dauData) + createBarChartCard('Monthly Active Users (MAU)', mauData);
                const openDoubtsData = { label: 'Open', value: parseNumeric(getCellValue(supportInfo, 1, 7)) }, totalDoubtsData = { label: 'Total Doubts', value: parseNumeric(getCellValue(supportInfo, 0, 7)) };
                const openTicketsData = { label: 'Open', value: parseNumeric(getCellValue(supportInfo, 3, 7)) }, totalTicketsData = { label: 'Total Tickets', value: parseNumeric(getCellValue(supportInfo, 2, 7)) };
                const supportContent = `<div class="flex justify-center"><div class="grid grid-cols-1 sm:grid-cols-2 gap-8 w-full max-w-3xl">${createSupportScorecard('Open Doubts', openDoubtsData, totalDoubtsData)}${createSupportScorecard('Open Support Tickets', openTicketsData, totalTicketsData)}</div></div>`;
                const batchInfoContent = () => {
                    if (!batchInfo) { return `<div class="sub-box bg-amber-900/30 text-amber-200 p-6 border border-amber-500/30 rounded-2xl text-center"><h3 class="text-xl font-bold mb-2"><i class="fas fa-exclamation-triangle mr-2"></i>Data Unavailable</h3><p>The batch information could not be loaded. Please try refreshing.</p></div>`; }
                    const generalMetrics = [{ 'Data Header': 'Total Enrolled Students', 'Value': batchInfo['Total enrolled students'], isPerformance: false }, { 'Data Header': 'Live Batches Count', 'Value': batchInfo['Live batches count'], isPerformance: false }];
                    const performanceMetrics = [{ 'Data Header': 'Average Attendance %', 'Value': batchInfo['Average Attendance %'], isPerformance: true }, { 'Data Header': 'Average LPS', 'Value': batchInfo['Average LPS'], isPerformance: true }, { 'Data Header': 'Tests Completion %', 'Value': batchInfo['Test Completion %'], isPerformance: true }];
                    const createBatchMetricCard = (metric) => { const colorState = metric.isPerformance ? getPerformanceColorState(metric['Data Header'], metric.Value) : 'neutral'; const colorClass = metric.isPerformance ? getPerformanceColorClass(colorState) : 'text-[var(--text-color)]'; return `<div class="small-metric-card metric-card h-full" data-color-state="${colorState}"><div class="flex-grow flex-shrink-0 p-4 flex flex-col items-center justify-center text-center space-y-2 min-w-0 rounded-3xl h-full"><div class="text-2xl text-[var(--icon-color)]"><i class="${getIconForMetric(metric['Data Header'])}"></i></div><div class="metric-value text-2xl md:text-3xl font-bold ${colorClass} tracking-tight">${metric.Value || 'N/A'}</div><div class="text-xs font-medium text-[var(--text-muted-color)]">${metric['Data Header']}</div></div></div>`; };
                    return `<div class="space-y-6"><div class="sub-box no-hover-pop bg-[var(--sub-box-bg)] p-6 border border-[var(--card-border)] rounded-2xl"><h3 class="text-xl font-bold text-center text-[var(--text-color)] opacity-90 mb-4">General Information</h3><div class="grid grid-cols-2 gap-4">${generalMetrics.map(createBatchMetricCard).join('')}</div></div><div class="sub-box no-hover-pop bg-[var(--sub-box-bg)] p-6 border border-[var(--card-border)] rounded-2xl"><h3 class="text-xl font-bold text-center text-[var(--text-color)] opacity-90 mb-4">Performance Data</h3><div class="flex flex-wrap justify-center gap-4 sm:grid sm:grid-cols-3"><div class="w-[calc(50%-0.5rem)] sm:w-auto">${createBatchMetricCard(performanceMetrics[0])}</div><div class="w-[calc(50%-0.5rem)] sm:w-auto">${createBatchMetricCard(performanceMetrics[1])}</div><div class="w-full max-w-[180px] sm:max-w-none sm:w-auto mx-auto sm:mx-0">${createBatchMetricCard(performanceMetrics[2])}</div></div></div></div>`;
                };
                container.innerHTML = `<div class="space-y-12"><div class="metric-card no-hover-pop bg-[var(--card-bg)] backdrop-blur-xl p-6 border border-[var(--card-border)] rounded-3xl space-y-8"><h2 class="text-2xl md:text-3xl font-bold text-[var(--text-color)] text-center flex justify-center items-center gap-4"><i class="fas fa-users"></i>User Analytics</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-8">${userAnalyticsContent}</div></div><div class="metric-card no-hover-pop bg-[var(--card-bg)] backdrop-blur-xl p-6 border border-[var(--card-border)] rounded-3xl space-y-8"><h2 class="text-2xl md:text-3xl font-bold text-[var(--text-color)] text-center flex justify-center items-center gap-4"><i class="fas fa-headset"></i>Student Support</h2>${supportContent}</div><div class="metric-card no-hover-pop bg-[var(--card-bg)] backdrop-blur-xl p-6 border border-[var(--card-border)] rounded-3xl space-y-8"><h2 class="text-2xl md:text-3xl font-bold text-[var(--text-color)] text-center flex justify-center items-center gap-4"><i class="fas fa-chalkboard-teacher"></i>Batches Information</h2>${batchInfoContent()}</div></div>`;
                triggerAnimations(container);
            };

            const renderDailyMetricsPage = (container, data) => {
                if (!data) { showError(container, "Could not load daily metrics data."); return; }
                const getCellValue = (row, col) => { const val = (data[row] && data[row][col] != null) ? data[row][col] : 'N/A'; return String(val).includes('#REF!') ? 'N/A' : val; };
                const parseNumeric = (val) => (val === 'N/A' || val == null) ? 0 : parseInt(String(val).replace(/,/g, ''), 10) || 0;
                const dauData = [{ label: 'Web', value: parseNumeric(getCellValue(5, 1)) }, { label: 'Android', value: parseNumeric(getCellValue(5, 2)) }, { label: 'iOS', value: parseNumeric(getCellValue(5, 3)) }];
                const mauData = [{ label: 'Web', value: parseNumeric(getCellValue(6, 1)) }, { label: 'Android', value: parseNumeric(getCellValue(6, 2)) }, { label: 'iOS', value: parseNumeric(getCellValue(6, 3)) }];
                const createLmsStatCard = (label, value, icon) => `<div class="small-metric-card metric-card flex-grow p-4 flex flex-col items-center text-center space-y-2 rounded-3xl"><div class="text-2xl text-[var(--icon-color)]"><i class="${icon}"></i></div><div class="metric-value text-2xl md:text-3xl font-bold text-[var(--text-color)] tracking-tight">${value || 'N/A'}</div><div class="text-xs font-medium text-[var(--text-muted-color)]">${label}</div></div>`;
                const lmsStatsContent = `<div class="metric-card no-hover-pop sub-box bg-[var(--card-bg)] backdrop-blur-xl p-6 border border-[var(--card-border)] rounded-2xl"><h3 class="text-2xl font-bold text-[var(--text-color)] opacity-90 mb-6 text-center flex items-center justify-center gap-3"><i class="fas fa-chart-bar"></i>LMS Web Stats</h3><div class="grid grid-cols-1 sm:grid-cols-3 gap-6">${createLmsStatCard('Total Learners', getCellValue(7, 1), getIconForMetric('learners'))}${createLmsStatCard('Tests Taken', getCellValue(8, 1), getIconForMetric('tests'))}${createLmsStatCard('Avg Time Spent', getCellValue(10, 1), getIconForMetric('time'))}</div></div>`;
                container.innerHTML = `<div class="space-y-8"><div class="metric-card no-hover-pop sub-box bg-[var(--card-bg)] backdrop-blur-xl p-6 border border-[var(--card-border)] rounded-2xl"><h3 class="text-2xl font-bold text-[var(--text-color)] opacity-90 mb-6 text-center flex items-center justify-center gap-3"><i class="fas fa-users"></i>Active Users</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-8">${createBarChartCard('Daily Active (DAU)', dauData)}${createBarChartCard('Monthly Active (MAU)', mauData)}</div></div>${lmsStatsContent}<div class="metric-card no-hover-pop sub-box bg-[var(--card-bg)] backdrop-blur-xl p-6 border border-[var(--card-border)] rounded-2xl"><h3 class="text-2xl font-bold text-[var(--text-color)] opacity-90 mb-6 text-center flex items-center justify-center gap-3"><i class="${getIconForMetric('rating')}"></i>Store Ratings</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-8">${createRatingScaleCard('Android', getIconForMetric('android'), getCellValue(1, 2), getCellValue(2, 2))}${createRatingScaleCard('iOS', getIconForMetric('ios'), getCellValue(1, 3), getCellValue(2, 3))}</div></div></div>`;
                triggerAnimations(container);
            };

            const getSuccessRateColor = (rateStr) => { const rate = parseFloat(rateStr); if (isNaN(rate)) return 'text-[var(--text-color)]'; if (rate <= 35) return 'text-red-500'; if (rate > 35 && rate <= 75) return 'text-amber-500'; return 'text-green-500'; };
            const getSuccessRateColorState = (rateStr) => { const rate = parseFloat(rateStr); if (isNaN(rate)) return 'neutral'; if (rate <= 35) return 'bad'; if (rate > 35 && rate <= 75) return 'medium'; return 'good'; };

            const renderCourseChecksPage = (container, data, days = 10) => {
                if (!data || !data.parsed || data.parsed.length === 0) { showError(container, "Could not load Course Checks data."); return; }
                const successRate = data.raw[0][2] ? String(data.raw[0][2]).trim() : 'N/A'; const successRateColor = getSuccessRateColor(successRate); const successRateState = getSuccessRateColorState(successRate);
                const allChartData = data.parsed.filter(row => row['Date'] && row['Pass %'] && String(row['Pass %']).trim() !== '' && !isNaN(parseFloat(row['Pass %']))).map(row => ({ date: row['Date'], value: parseFloat(row['Pass %']) }));
                if (allChartData.length === 0) { showError(container, "No valid data for Course Checks chart."); return; }
                const chartData = allChartData.slice(-days);
                container.innerHTML = `<div class="space-y-8"><div class="metric-card no-hover-pop bg-[var(--card-bg)] backdrop-blur-xl p-8 rounded-3xl text-center" data-color-state="${successRateState}"><h3 class="text-lg font-medium text-[var(--text-muted-color)] uppercase tracking-widest">Success Rate</h3><div class="text-7xl sm:text-8xl font-bold my-2 tracking-tighter ${successRateColor}">${successRate}</div></div><div class="metric-card no-hover-pop bg-[var(--card-bg)] backdrop-blur-xl p-6 border border-[var(--card-border)] rounded-2xl"><div class="flex flex-col sm:flex-row justify-center mb-6 items-center gap-2 sm:gap-4"><h4 class="text-sm font-semibold text-[var(--text-muted-color)]">View Previous:</h4><div id="timeline-toggle" class="timeline-toggle bg-[var(--sub-box-bg)] rounded-full p-1 flex flex-wrap justify-center gap-1"><button data-days="7" class="timeline-btn px-4 py-1.5 text-sm font-semibold rounded-full">7 Days</button><button data-days="10" class="timeline-btn px-4 py-1.5 text-sm font-semibold rounded-full">10 Days</button><button data-days="14" class="timeline-btn px-4 py-1.5 text-sm font-semibold rounded-full">14 Days</button><button data-days="30" class="timeline-btn px-4 py-1.5 text-sm font-semibold rounded-full">30 Days</button></div></div><div class="min-h-[300px] sm:min-h-[400px]"><canvas id="courseChecksChartCanvas"></canvas></div><div class="mt-4 p-4 bg-[var(--sub-box-bg)] rounded-2xl text-center text-sm text-[var(--text-muted-color)] md:hidden"><i class="fas fa-info-circle mr-2"></i>For the best experience, please view on a desktop.</div></div></div>`;
                const timelineButtons = container.querySelectorAll('#timeline-toggle .timeline-btn');
                timelineButtons.forEach(btn => { if (parseInt(btn.dataset.days) === days) btn.classList.add('active'); btn.addEventListener('click', () => renderCourseChecksPage(container, data, parseInt(btn.dataset.days))); });
                const ctx = document.getElementById('courseChecksChartCanvas').getContext('2d');
                if (chartInstances.courseChecksChart) chartInstances.courseChecksChart.destroy();
                const isLightMode = document.body.classList.contains('light-mode'), isMobile = window.innerWidth < 768; const gridColor = isLightMode ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.1)'; const tickColor = isLightMode ? '#515154' : '#a1a1a6'; const bodyFont = "'Inter', sans-serif";
                chartInstances.courseChecksChart = new Chart(ctx, { type: 'line', data: { labels: chartData.map(d => d.date), datasets: [{ label: 'Pass %', data: chartData.map(d => d.value), borderWidth: isMobile ? 2 : 3, pointRadius: isMobile ? 3 : 5, pointHoverRadius: isMobile ? 6 : 8, tension: 0.1, fill: false, segment: { borderColor: ctx => { const y = ctx.p1.parsed.y; if (y <= 35) return 'rgb(239, 68, 68)'; if (y > 35 && y <= 75) return 'rgb(245, 158, 11)'; return 'rgb(34, 197, 94)'; } }, pointBorderColor: (ctx) => { const y = ctx.raw; if (y <= 35) return 'rgb(239, 68, 68)'; if (y > 35 && y <= 75) return 'rgb(245, 158, 11)'; return 'rgb(34, 197, 94)'; }, pointBackgroundColor: (ctx) => { const y = ctx.raw; if (y <= 35) return 'rgba(239,68,68,0.5)'; if (y > 35 && y <= 75) return 'rgba(245,158,11,0.5)'; return 'rgba(34,197,94,0.5)'; } }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { enabled: true, backgroundColor: 'rgba(0,0,0,0.8)', titleFont: { family: bodyFont, size: 14, weight: 'bold' }, bodyFont: { family: bodyFont, size: 12 }, padding: 12, cornerRadius: 8, displayColors: false, callbacks: { label: c => `Pass Rate: ${c.raw}%` } } }, scales: { y: { min: 0, max: 100, grid: { color: gridColor }, ticks: { stepSize: 20, color: tickColor, font: { family: bodyFont }, callback: v => v + '%' } }, x: { grid: { display: false }, ticks: { color: tickColor, font: { family: bodyFont }, maxTicksLimit: isMobile ? 6 : undefined } } } } });
            };

            const renderQuestionRepoPage = (container, accaData, cfaData, overallData) => {
                if (!accaData || !cfaData || !overallData) { showError(container, "Could not load all necessary Question Repository data."); return; }
                ['accaPieChart', 'accaLineChart', 'cfaPieChart', 'cfaLineChart', 'overallLineChart'].forEach(key => { if (chartInstances[key]) chartInstances[key].destroy(); });
                const parseNumericValue = (val) => val ? parseInt(String(val).replace(/,/g, ''), 10) : 0;
                const accaDraft = parseNumericValue(accaData.summary.draft), accaApproved = parseNumericValue(accaData.summary.approved);
                const cfaDraft = parseNumericValue(cfaData.summary.draft), cfaApproved = parseNumericValue(cfaData.summary.approved);
                const getCompletionColorState = (valueStr) => { const value = parseFloat(valueStr); if (isNaN(value)) return 'neutral'; if (value <= 35) return 'bad'; if (value < 70) return 'medium'; return 'good'; };
                container.innerHTML = `<div class="space-y-8"><div id="acca-qrf-content" class="qrf-content-section space-y-8"><div class="metric-card no-hover-pop bg-[var(--card-bg)] backdrop-blur-xl p-6 md:p-8 border border-[var(--card-border)] rounded-3xl space-y-8"><h2 class="text-2xl md:text-3xl font-bold text-[var(--text-color)] text-center">ACCA Question Status</h2><div class="grid grid-cols-1 lg:grid-cols-3 gap-8 items-center"><div class="lg:col-span-1 relative h-60 md:h-72"><canvas id="accaPieChartCanvas"></canvas></div><div class="flex flex-col justify-center space-y-4"><div class="pie-legend-item flex items-center justify-between bg-[var(--sub-box-bg)] p-4 rounded-2xl"><div class="flex items-center gap-3"><div class="w-3 h-3 rounded-full bg-red-500"></div><span class="text-lg font-medium text-[var(--text-muted-color)]">Draft</span></div><span class="text-2xl font-semibold text-[var(--text-color)]">${accaDraft.toLocaleString()}</span></div><div class="pie-legend-item flex items-center justify-between bg-[var(--sub-box-bg)] p-4 rounded-2xl"><div class="flex items-center gap-3"><div class="w-3 h-3 rounded-full bg-green-500"></div><span class="text-lg font-medium text-[var(--text-muted-color)]">Approved</span></div><span class="text-2xl font-semibold text-[var(--text-color)]">${accaApproved.toLocaleString()}</span></div></div><div class="qrf-scorecard text-center p-6 bg-[var(--sub-box-bg)] rounded-3xl border border-[var(--card-border)]" data-color-state="${getCompletionColorState(accaData.summary.completion)}"><div class="value text-5xl sm:text-7xl font-bold ${getPerformanceColorClass(getCompletionColorState(accaData.summary.completion))} tracking-tighter">${accaData.summary.completion || 'N/A'}</div><div class="text-lg text-[var(--text-muted-color)] mt-1">Completion</div></div></div></div><div class="metric-card no-hover-pop bg-[var(--card-bg)] backdrop-blur-xl p-6 border border-[var(--card-border)] rounded-2xl"><div class="flex flex-wrap items-center justify-between gap-y-4 gap-x-6 mb-6"><div class="flex items-center gap-2 md:gap-4"><h4 class="text-sm font-semibold text-[var(--text-muted-color)]">Trend:</h4><div class="timeline-toggle bg-[var(--sub-box-bg)] rounded-full p-1 flex gap-1" data-chart-type="acca"><button data-days="7" class="timeline-btn px-3 py-1.5 text-sm font-semibold rounded-full">7 Days</button><button data-days="14" class="timeline-btn px-3 py-1.5 text-sm font-semibold rounded-full active">14 Days</button><button data-days="30" class="timeline-btn px-3 py-1.5 text-sm font-semibold rounded-full">30 Days</button></div></div><div class="flex items-center gap-2" id="acca-legend-toggle"></div></div><div class="min-h-[300px] sm:min-h-[350px]"><canvas id="accaLineChartCanvas"></canvas></div><div class="mt-4 p-4 bg-[var(--sub-box-bg)] rounded-2xl text-center text-sm text-[var(--text-muted-color)] md:hidden"><i class="fas fa-info-circle mr-2"></i>For the best experience, please view on a desktop.</div></div><div class="metric-card no-hover-pop bg-[var(--card-bg)] backdrop-blur-xl p-6 md:p-8 border border-[var(--card-border)] rounded-3xl space-y-8"><h2 class="text-2xl md:text-3xl font-bold text-[var(--text-color)] text-center">ACCA Questions Split</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-8"><div class="split-box bg-[var(--sub-box-bg)] p-6 rounded-2xl border border-[var(--card-border)]"><h3 class="text-xl font-bold text-center mb-4">Non-Subjective Questions</h3><div class="flex flex-row justify-around items-center gap-4"><div class="qrf-scorecard bg-[var(--sub-box-bg)] p-4 rounded-xl flex-1 text-center border border-[var(--card-border)]"><div class="value text-3xl sm:text-4xl font-bold">${accaData.summary.nonSubjectiveCount}</div><div class="text-sm text-[var(--text-muted-color)]">Count</div></div><div class="qrf-scorecard bg-[var(--sub-box-bg)] p-4 rounded-xl flex-1 text-center border border-[var(--card-border)]"><div class="value text-3xl sm:text-4xl font-bold">${accaData.summary.nonSubjectivePercent}</div><div class="text-sm text-[var(--text-muted-color)]">Percentage</div></div></div></div><div class="split-box bg-[var(--sub-box-bg)] p-6 rounded-2xl border border-[var(--card-border)]"><h3 class="text-xl font-bold text-center mb-4">Subjective Questions</h3><div class="flex flex-row justify-around items-center gap-4"><div class="qrf-scorecard bg-[var(--sub-box-bg)] p-4 rounded-xl flex-1 text-center border border-[var(--card-border)]"><div class="value text-3xl sm:text-4xl font-bold">${accaData.summary.subjectiveCount}</div><div class="text-sm text-[var(--text-muted-color)]">Count</div></div><div class="qrf-scorecard bg-[var(--sub-box-bg)] p-4 rounded-xl flex-1 text-center border border-[var(--card-border)]"><div class="value text-3xl sm:text-4xl font-bold">${accaData.summary.subjectivePercent}</div><div class="text-sm text-[var(--text-muted-color)]">Percentage</div></div></div></div></div><div class="split-box bg-[var(--sub-box-bg)] p-6 rounded-2xl border border-[var(--card-border)] mt-8 flex justify-center items-center gap-6"><h3 class="text-xl sm:text-2xl font-bold">Total Questions</h3><div class="text-4xl sm:text-5xl font-bold">${accaData.summary.totalQuestions}</div></div></div></div><div id="cfa-qrf-content" class="qrf-content-section space-y-8 hidden"><div class="metric-card no-hover-pop bg-[var(--card-bg)] backdrop-blur-xl p-6 md:p-8 border border-[var(--card-border)] rounded-3xl space-y-8"><h2 class="text-2xl md:text-3xl font-bold text-[var(--text-color)] text-center">CFA Question Status</h2><div class="grid grid-cols-1 lg:grid-cols-3 gap-8 items-center"><div class="lg:col-span-1 relative h-60 md:h-72"><canvas id="cfaPieChartCanvas"></canvas></div><div class="flex flex-col justify-center space-y-4"><div class="pie-legend-item flex items-center justify-between bg-[var(--sub-box-bg)] p-4 rounded-2xl"><div class="flex items-center gap-3"><div class="w-3 h-3 rounded-full bg-red-500"></div><span class="text-lg font-medium text-[var(--text-muted-color)]">Draft</span></div><span class="text-2xl font-semibold text-[var(--text-color)]">${cfaDraft.toLocaleString()}</span></div><div class="pie-legend-item flex items-center justify-between bg-[var(--sub-box-bg)] p-4 rounded-2xl"><div class="flex items-center gap-3"><div class="w-3 h-3 rounded-full bg-green-500"></div><span class="text-lg font-medium text-[var(--text-muted-color)]">Approved</span></div><span class="text-2xl font-semibold text-[var(--text-color)]">${cfaApproved.toLocaleString()}</span></div></div><div class="qrf-scorecard text-center p-6 bg-[var(--sub-box-bg)] rounded-3xl border border-[var(--card-border)]" data-color-state="${getCompletionColorState(cfaData.summary.completion)}"><div class="value text-5xl sm:text-7xl font-bold ${getPerformanceColorClass(getCompletionColorState(cfaData.summary.completion))} tracking-tighter">${cfaData.summary.completion || 'N/A'}</div><div class="text-lg text-[var(--text-muted-color)] mt-1">Completion</div></div></div></div><div class="metric-card no-hover-pop bg-[var(--card-bg)] backdrop-blur-xl p-6 border border-[var(--card-border)] rounded-2xl"><div class="flex flex-wrap items-center justify-between gap-y-4 gap-x-6 mb-6"><div class="flex items-center gap-2 md:gap-4"><h4 class="text-sm font-semibold text-[var(--text-muted-color)]">Trend:</h4><div class="timeline-toggle bg-[var(--sub-box-bg)] rounded-full p-1 flex gap-1" data-chart-type="cfa"><button data-days="7" class="timeline-btn px-3 py-1.5 text-sm font-semibold rounded-full">7 Days</button><button data-days="14" class="timeline-btn px-3 py-1.5 text-sm font-semibold rounded-full active">14 Days</button><button data-days="30" class="timeline-btn px-3 py-1.5 text-sm font-semibold rounded-full">30 Days</button></div></div><div class="flex items-center gap-2" id="cfa-legend-toggle"></div></div><div class="min-h-[300px] sm:min-h-[350px]"><canvas id="cfaLineChartCanvas"></canvas></div><div class="mt-4 p-4 bg-[var(--sub-box-bg)] rounded-2xl text-center text-sm text-[var(--text-muted-color)] md:hidden"><i class="fas fa-info-circle mr-2"></i>For the best experience, please view on a desktop.</div></div></div><div id="overall-qrf-content" class="qrf-content-section space-y-8 hidden"><div class="metric-card no-hover-pop bg-[var(--card-bg)] backdrop-blur-xl p-6 md:p-8 border border-[var(--card-border)] rounded-3xl space-y-8"><div class="border-b border-[var(--card-border)] pb-4 mb-6 md:mb-8"><h3 class="text-2xl md:text-3xl font-bold text-center text-[var(--text-color)]">Overall</h3></div><div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center"><div class="space-y-4"><div class="qrf-scorecard bg-[var(--sub-box-bg)] p-4 rounded-xl flex justify-between items-center border border-[var(--card-border)]"><span class="text-lg font-medium text-[var(--text-muted-color)]">Draft</span><span class="value text-2xl md:text-3xl font-semibold text-[var(--text-color)]">${overallData.summary.draft || 'N/A'}</span></div><div class="qrf-scorecard bg-[var(--sub-box-bg)] p-4 rounded-xl flex justify-between items-center border border-[var(--card-border)]"><span class="text-lg font-medium text-[var(--text-muted-color)]">Approved</span><span class="value text-2xl md:text-3xl font-semibold text-[var(--text-color)]">${overallData.summary.approved || 'N/A'}</span></div><div class="qrf-scorecard bg-[var(--sub-box-bg)] p-4 rounded-xl flex justify-between items-center border border-[var(--card-border)]"><span class="text-lg font-medium text-[var(--text-muted-color)]">Total</span><span class="value text-2xl md:text-3xl font-semibold text-[var(--text-color)]">${overallData.summary.total || 'N/A'}</span></div></div><div class="qrf-scorecard bg-[var(--sub-box-bg)] p-6 rounded-3xl text-center border border-transparent" data-color-state="${getCompletionColorState(overallData.summary.completion)}"><div class="value text-6xl sm:text-7xl font-bold ${getPerformanceColorClass(getCompletionColorState(overallData.summary.completion))} tracking-tighter">${overallData.summary.completion || 'N/A'}</div><div class="text-xl text-[var(--text-muted-color)] mt-1">Completion</div></div></div></div><div class="metric-card no-hover-pop bg-[var(--card-bg)] backdrop-blur-xl p-6 border border-[var(--card-border)] rounded-2xl mt-8"><div class="flex flex-wrap items-center justify-between gap-y-4 gap-x-6 mb-6"><div class="flex items-center gap-2 md:gap-4"><h4 class="text-sm font-semibold text-[var(--text-muted-color)]">Trend:</h4><div class="timeline-toggle bg-[var(--sub-box-bg)] rounded-full p-1 flex gap-1" data-chart-type="overall"><button data-days="7" class="timeline-btn px-3 py-1.5 text-sm font-semibold rounded-full">7 Days</button><button data-days="14" class="timeline-btn px-3 py-1.5 text-sm font-semibold rounded-full active">14 Days</button><button data-days="30" class="timeline-btn px-3 py-1.5 text-sm font-semibold rounded-full">30 Days</button></div></div><div class="flex items-center gap-2" id="overall-legend-toggle"></div></div><div class="min-h-[300px] sm:min-h-[350px]"><canvas id="overallLineChartCanvas"></canvas></div><div class="mt-4 p-4 bg-[var(--sub-box-bg)] rounded-2xl text-center text-sm text-[var(--text-muted-color)] md:hidden"><i class="fas fa-info-circle mr-2"></i>For the best experience, please view on a desktop.</div></div></div></div>`;
                const isLightMode = document.body.classList.contains('light-mode'), bodyFont = "'Inter', sans-serif"; const textColor = isLightMode ? '#1d1d1f' : '#f5f5f7'; const gridColor = isLightMode ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.1)'; const tickColor = isLightMode ? '#515154' : '#a1a1a6';
                const renderPieChart = (canvasId, data, total) => { const ctx = document.getElementById(canvasId).getContext('2d'); const isLightMode = document.body.classList.contains('light-mode'); const pieBorderColor = isLightMode ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.1)'; const textColor = isLightMode ? '#1c1c1e' : '#f0f0f0'; const mutedTextColor = isLightMode ? '#3a3a3c' : '#9a9a9e'; return new Chart(ctx, { type: 'doughnut', data: { labels: ['Draft', 'Approved'], datasets: [{ data, backgroundColor: ['#ef4444', '#22c55e'], borderColor: pieBorderColor, borderWidth: 3, hoverBorderColor: pieBorderColor }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { display: false }, tooltip: { enabled: true, bodyFont: { family: bodyFont }, titleFont: { family: bodyFont }, backgroundColor: 'rgba(0,0,0,0.8)', padding: 12, cornerRadius: 8 } }, animation: { animateScale: true, animateRotate: true } }, plugins: [{ id: 'doughnutLabel', beforeDraw: (chart) => { const { width, height, ctx } = chart; ctx.restore(); const fontSize = (height/150).toFixed(2); ctx.font = `bold ${fontSize}em ${bodyFont}`; ctx.textBaseline = 'middle'; const text = total.toLocaleString(), textX = Math.round((width - ctx.measureText(text).width)/2), textY = height/2.2; ctx.fillStyle = textColor; ctx.fillText(text, textX, textY); const subText = 'Total', subFontSize = (height/280).toFixed(2); ctx.font = `${subFontSize}em ${bodyFont}`; const subTextX = Math.round((width - ctx.measureText(subText).width)/2); ctx.fillStyle = mutedTextColor; ctx.fillText(subText, subTextX, height/1.7); ctx.save(); } }] }); };
                chartInstances.accaPieChart = renderPieChart('accaPieChartCanvas', [accaDraft, accaApproved], accaDraft + accaApproved);
                chartInstances.cfaPieChart = renderPieChart('cfaPieChartCanvas', [cfaDraft, cfaApproved], cfaDraft + cfaApproved);
                const renderLineChart = (canvasId, dailyData, days, visibleDatasets) => { const isMobile = window.innerWidth < 768; const chartData = dailyData.filter(d => d.Date && d.Draft != null && d.Approved != null && d.Draft !== '' && d.Approved !== '' && !isNaN(new Date(d.Date).getTime())).slice(-days); const chartLabels = chartData.map(d => new Date(d.Date).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' })); const yAxisConfig = { grid: { color: gridColor }, ticks: { color: tickColor, font: { family: bodyFont } } }; if (visibleDatasets[0] === 1 && visibleDatasets[1] === 0) { yAxisConfig.min = 0; } const ctx = document.getElementById(canvasId).getContext('2d'); return new Chart(ctx, { type: 'line', data: { labels: chartLabels, datasets: [{ label: 'Draft', data: chartData.map(d => parseNumericValue(d.Draft)), borderColor: 'rgb(239, 68, 68)', backgroundColor: 'rgba(239, 68, 68, 0.1)', tension: 0.4, borderWidth: isMobile ? 2 : 3, pointRadius: isMobile ? 3 : 4, pointHoverRadius: isMobile ? 6 : 7, fill: true }, { label: 'Approved', data: chartData.map(d => parseNumericValue(d.Approved)), borderColor: 'rgb(34, 197, 94)', backgroundColor: 'rgba(34, 197, 94, 0.1)', tension: 0.4, borderWidth: isMobile ? 2 : 3, pointRadius: isMobile ? 3 : 4, pointHoverRadius: isMobile ? 6 : 7, fill: true }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { enabled: true, mode: 'index', intersect: false, position: 'nearest', backgroundColor: 'rgba(29, 29, 31, 0.95)', borderColor: 'rgba(255, 255, 255, 0.2)', borderWidth: 1, titleColor: '#f5f5f7', bodyColor: '#a1a1a6', titleFont: { family: bodyFont, size: 13, weight: 'bold' }, bodyFont: { family: bodyFont, size: 12 }, padding: 10, cornerRadius: 8, displayColors: true, caretSize: 6, caretPadding: 10, callbacks: { title: tt => tt[0].label, label: c => { let l = c.dataset.label || ''; if (l) l += ': '; if (c.parsed.y !== null) l += new Intl.NumberFormat('en-US').format(c.parsed.y); return l; } } } }, scales: { y: yAxisConfig, x: { grid: { display: false }, ticks: { color: tickColor, font: { family: bodyFont }, maxTicksLimit: isMobile ? 6 : undefined, maxRotation: 0, minRotation: 0 } } } } }); };
                const setupSubPage = (chartType, dailyData) => { const canvasId = `${chartType}LineChartCanvas`, timelineToggle = document.querySelector(`.timeline-toggle[data-chart-type="${chartType}"]`), legendContainer = document.getElementById(`${chartType}-legend-toggle`); let chartInstance, currentDays = 14, visibleDatasets = [1, 1]; const updateChart = () => { if (chartInstance) chartInstance.destroy(); chartInstance = renderLineChart(canvasId, dailyData, currentDays, visibleDatasets); visibleDatasets.forEach((v, i) => chartInstance.setDatasetVisibility(i, v === 1)); chartInstance.update(); if (chartType === 'acca') chartInstances.accaLineChart = chartInstance; else if (chartType === 'cfa') chartInstances.cfaLineChart = chartInstance; else if (chartType === 'overall') chartInstances.overallLineChart = chartInstance; legendContainer.innerHTML = ''; chartInstance.data.datasets.forEach((dataset, index) => { const button = document.createElement('button'); button.className = `flex items-center gap-2 px-3 py-1.5 text-sm font-semibold rounded-full transition-all duration-300 bg-[var(--sub-box-bg)] backdrop-blur-sm border border-[var(--card-border)] hover:bg-[var(--card-hover-bg)] hover:scale-105 ${visibleDatasets[index] !== 1 ? 'opacity-40' : ''}`; button.innerHTML = `<div class="w-3 h-3 rounded-full" style="background-color: ${dataset.borderColor}"></div> ${dataset.label}`; button.onclick = () => { const isVisible = visibleDatasets[index] === 1; if (visibleDatasets.filter(v=>v===1).length === 1 && isVisible) return; visibleDatasets[index] = isVisible ? 0 : 1; updateChart(); }; legendContainer.appendChild(button); }); }; timelineToggle.querySelectorAll('.timeline-btn').forEach(btn => { btn.addEventListener('click', e => { timelineToggle.querySelector('.active')?.classList.remove('active'); e.target.classList.add('active'); currentDays = parseInt(e.target.dataset.days); updateChart(); }); }); timelineToggle.querySelector(`[data-days="${currentDays}"]`)?.classList.add('active'); updateChart(); };
                setupSubPage('acca', accaData.daily); setupSubPage('cfa', cfaData.daily); setupSubPage('overall', overallData.daily);
            };

            const renderBatchReportsPage = (container, data) => {
                if (!data) { showError(container, "Could not load Batch Reports data."); return; }
                const getCellValue = (data, row, col) => { const val = (data && data[row] && data[row][col] != null) ? data[row][col] : '--'; return String(val).includes('#REF!') ? '--' : val; };
                const generalData = [{ 'Data Header': 'Total Enrolled Students', 'Value': getCellValue(data, 0, 1) }, { 'Data Header': 'Live Batches Count', 'Value': getCellValue(data, 1, 1) }];
                const performanceData = [{ 'Data Header': 'Average Attendance %', 'Value': getCellValue(data, 2, 1) }, { 'Data Header': 'Average LPS', 'Value': getCellValue(data, 3, 1) }, { 'Data Header': 'Tests Completion %', 'Value': getCellValue(data, 4, 1) }];
                const createMetricCard = (metric, isPerformance = false) => { const colorState = isPerformance ? getPerformanceColorState(metric['Data Header'], metric.Value) : 'neutral'; const colorClass = isPerformance ? getPerformanceColorClass(colorState) : 'text-[var(--text-color)]'; return `<div class="small-metric-card metric-card p-6 rounded-2xl flex flex-col items-center justify-center text-center space-y-2" data-color-state="${colorState}"><i class="${getIconForMetric(metric['Data Header'])} text-2xl md:text-3xl text-[var(--icon-color)] opacity-80"></i><div class="text-3xl md:text-4xl font-bold ${colorClass} tracking-tight">${metric.Value || 'N/A'}</div><div class="text-sm font-medium text-[var(--text-muted-color)]">${metric['Data Header']}</div></div>`; };
                container.innerHTML = `<div class="space-y-10"><div class="metric-card no-hover-pop sub-box bg-[var(--card-bg)] backdrop-blur-xl p-8 border border-[var(--card-border)] rounded-3xl"><h3 class="text-xl md:text-2xl font-bold text-[var(--text-color)] opacity-90 mb-6 text-center">General</h3><div class="grid grid-cols-2 gap-6">${generalData.map(m => createMetricCard(m, false)).join('')}</div></div><div class="metric-card no-hover-pop sub-box bg-[var(--card-bg)] backdrop-blur-xl p-8 border border-[var(--card-border)] rounded-3xl"><h3 class="text-xl md:text-2xl font-bold text-[var(--text-color)] opacity-90 mb-6 text-center">Performance Data</h3><div class="flex flex-col items-center gap-6 md:grid md:grid-cols-3"><div class="w-full grid grid-cols-2 md:col-span-2 gap-6">${createMetricCard(performanceData[0], true)}${createMetricCard(performanceData[1], true)}</div><div class="w-1/2 md:w-full md:col-span-1">${createMetricCard(performanceData[2], true)}</div></div></div></div>`;
            };

            const renderAskADoubtPage = (container, summaryData, trendsData, totalTrendsData) => {
                if (!summaryData) { showError(container, "Could not load Support data."); return; }
                const getMetricValue = (key) => summaryData[key] || 'N/A', openDoubts = parseInt(getMetricValue('Open Doubts'), 10), openTickets = parseInt(getMetricValue('Open Support Tickets'), 10);
                const getCondColor = v => isNaN(v) ? 'text-[var(--text-color)]' : v >= 10 ? 'text-red-500' : 'text-green-500';
                const getCondIcon = (v, h, l) => isNaN(v) ? h : v >= 10 ? h : l;
                const getCondState = v => isNaN(v) ? 'neutral' : v >= 10 ? 'bad' : 'good';
                const createMetricCard = (label, value, icon, colorClass='text-[var(--text-color)]', state='neutral') => `<div class="small-metric-card metric-card flex-1 flex-shrink-0 p-4 flex flex-col items-center text-center space-y-2 min-w-0 rounded-3xl" data-color-state="${state}"><div class="text-2xl ${colorClass}"><i class="${icon}"></i></div><div class="metric-value text-2xl md:text-3xl font-bold ${colorClass} tracking-tight">${value}</div><div class="text-xs font-medium text-[var(--text-muted-color)]">${label}</div></div>`;
                container.innerHTML = `<div class="space-y-8"><div class="metric-card no-hover-pop flex flex-col sm:flex-row gap-8 items-start p-6 rounded-3xl"><div class="sub-box bg-[var(--sub-box-bg)] p-8 border border-[var(--card-border)] rounded-2xl space-y-6 flex-1 w-full"><h3 class="text-xl md:text-2xl font-bold text-[var(--text-color)] opacity-90 text-center flex items-center justify-center gap-3">Ask a Doubt</h3><div class="card-grid force-row flex flex-nowrap justify-center gap-4 mt-auto">${createMetricCard('Total Doubts', getMetricValue('Total Doubts'), 'fas fa-question-circle')}${createMetricCard('Open Doubts', getMetricValue('Open Doubts'), getCondIcon(openDoubts, 'fas fa-exclamation-circle', 'fas fa-check-circle'), getCondColor(openDoubts), getCondState(openDoubts))}</div></div><div class="sub-box bg-[var(--sub-box-bg)] p-8 border border-[var(--card-border)] rounded-2xl space-y-6 flex-1 w-full"><h3 class="text-xl md:text-2xl font-bold text-[var(--text-color)] opacity-90 text-center flex items-center justify-center gap-3">LMS Tickets</h3><div class="card-grid force-row flex flex-nowrap justify-center gap-4 mt-auto">${createMetricCard('Total Support Tickets', getMetricValue('Total Support Tickets'), 'fas fa-ticket-alt')}${createMetricCard('Open Support Tickets', getMetricValue('Open Support Tickets'), getCondIcon(openTickets, 'fas fa-exclamation-triangle', 'fas fa-check-circle'), getCondColor(openTickets), getCondState(openTickets))}</div></div></div><div id="support-trends-section" class="metric-card no-hover-pop bg-[var(--card-bg)] backdrop-blur-xl p-6 border border-[var(--card-border)] rounded-2xl"></div><div id="total-support-trends-section" class="metric-card no-hover-pop bg-[var(--card-bg)] backdrop-blur-xl p-6 border border-[var(--card-border)] rounded-2xl"></div></div>`;
                if (chartInstances.supportLineChart) chartInstances.supportLineChart.destroy(); if (chartInstances.totalSupportLineChart) chartInstances.totalSupportLineChart.destroy();
                const trendsContainer = container.querySelector('#support-trends-section');
                if (!trendsData) trendsContainer.innerHTML = `<p class="text-center text-[var(--text-muted-color)]">Could not load open items trends data.</p>`;
                else { trendsContainer.innerHTML = `<h3 class="text-xl md:text-2xl font-bold text-[var(--text-color)] opacity-90 text-center mb-6">Open Doubts & Tickets</h3><div class="flex flex-wrap items-center justify-between gap-y-4 gap-x-6 mb-6"><div class="flex items-center gap-2 md:gap-4"><h4 class="text-sm font-semibold text-[var(--text-muted-color)]">View Trends For:</h4><div id="support-timeline-toggle" class="timeline-toggle bg-[var(--sub-box-bg)] rounded-full p-1 flex flex-wrap justify-center gap-1"><button data-days="7" class="timeline-btn px-4 py-1.5 text-sm font-semibold rounded-full active">7 Days</button><button data-days="14" class="timeline-btn px-4 py-1.5 text-sm font-semibold rounded-full">14 Days</button><button data-days="30" class="timeline-btn px-4 py-1.5 text-sm font-semibold rounded-full">30 Days</button></div></div><div class="flex items-center gap-2" id="support-legend-toggle"></div></div><div class="min-h-[300px] sm:min-h-[400px]"><canvas id="supportLineChartCanvas"></canvas></div><div class="mt-4 p-4 bg-[var(--sub-box-bg)] rounded-2xl text-center text-sm text-[var(--text-muted-color)] md:hidden"><i class="fas fa-info-circle mr-2"></i>For the best experience, please view on a desktop.</div>`; setupSupportChart('support', trendsData, [{ label: 'Open Doubts', dataKey: 'doubts', color: 'rgb(239, 68, 68)' }, { label: 'Open Tickets', dataKey: 'tickets', color: 'rgb(59, 130, 246)' }]); }
                const totalTrendsContainer = container.querySelector('#total-support-trends-section');
                if (!totalTrendsData) totalTrendsContainer.innerHTML = `<p class="text-center text-[var(--text-muted-color)]">Could not load total items trends data.</p>`;
                else { totalTrendsContainer.innerHTML = `<h3 class="text-xl md:text-2xl font-bold text-[var(--text-color)] opacity-90 text-center mb-6">Total Doubts & Tickets</h3><div class="flex flex-wrap items-center justify-between gap-y-4 gap-x-6 mb-6"><div class="flex items-center gap-2 md:gap-4"><h4 class="text-sm font-semibold text-[var(--text-muted-color)]">View Trends For:</h4><div id="total-support-timeline-toggle" class="timeline-toggle bg-[var(--sub-box-bg)] rounded-full p-1 flex flex-wrap justify-center gap-1"><button data-days="7" class="timeline-btn px-4 py-1.5 text-sm font-semibold rounded-full active">7 Days</button><button data-days="14" class="timeline-btn px-4 py-1.5 text-sm font-semibold rounded-full">14 Days</button><button data-days="30" class="timeline-btn px-4 py-1.5 text-sm font-semibold rounded-full">30 Days</button></div></div><div class="flex items-center gap-2" id="total-support-legend-toggle"></div></div><div class="min-h-[300px] sm:min-h-[400px]"><canvas id="totalSupportLineChartCanvas"></canvas></div><div class="mt-4 p-4 bg-[var(--sub-box-bg)] rounded-2xl text-center text-sm text-[var(--text-muted-color)] md:hidden"><i class="fas fa-info-circle mr-2"></i>For the best experience, please view on a desktop.</div>`; setupSupportChart('total-support', totalTrendsData, [{ label: 'Total Doubts', dataKey: 'totalDoubts', color: 'rgb(245, 158, 11)' }, { label: 'Total Tickets', dataKey: 'totalTickets', color: 'rgb(139, 92, 246)' }]); }
            };

            const setupSupportChart = (type, chartRawData, datasetConfigs) => { const timelineToggle = document.querySelector(`#${type}-timeline-toggle`), legendContainer = document.getElementById(`${type}-legend-toggle`), canvasId = type.replace(/-(\w)/g, (m, l) => l.toUpperCase()) + 'LineChartCanvas'; let chartInstance, currentDays = 7, visibleDatasets = [1, 1]; const updateLegend = () => { legendContainer.innerHTML = ''; datasetConfigs.forEach((config, index) => { const button = document.createElement('button'); button.className = `flex items-center gap-2 px-3 py-1.5 text-sm font-semibold rounded-full transition-all duration-300 bg-[var(--sub-box-bg)] backdrop-blur-sm border border-[var(--card-border)] hover:bg-[var(--card-hover-bg)] hover:scale-105 ${visibleDatasets[index] !== 1 ? 'opacity-40' : ''}`; button.innerHTML = `<div class="w-3 h-3 rounded-full" style="background-color: ${config.color}"></div> ${config.label}`; button.onclick = () => { const isVisible = visibleDatasets[index] === 1; if (visibleDatasets.filter(v=>v===1).length === 1 && isVisible) return; visibleDatasets[index] = isVisible ? 0 : 1; renderChart(); }; legendContainer.appendChild(button); }); }; const renderChart = () => { if (chartInstance) chartInstance.destroy(); const chartDataPoints = chartRawData.slice(-currentDays), canvas = document.getElementById(canvasId); if (!canvas) return; const ctx = canvas.getContext('2d'); const isLightMode = document.body.classList.contains('light-mode'), tickColor = isLightMode ? '#515154' : '#a1a1a6'; if (chartDataPoints.length === 0) { ctx.clearRect(0,0,canvas.width,canvas.height); ctx.font = "16px 'Inter', sans-serif"; ctx.fillStyle = tickColor; ctx.textAlign = "center"; ctx.fillText("No data available for this period.", canvas.width/2, canvas.height/2); legendContainer.innerHTML = ''; return; } const labels = chartDataPoints.map(d => d.date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' })), isMobile = window.innerWidth < 768, gridColor = isLightMode ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.1)', bodyFont = "'Inter', sans-serif"; const datasets = datasetConfigs.map((config, index) => ({ label: config.label, data: chartDataPoints.map(d => d[config.dataKey]), borderColor: config.color, backgroundColor: config.color.replace('rgb', 'rgba').replace(')', ', 0.1)'), hidden: visibleDatasets[index] !== 1, borderWidth: isMobile ? 2 : 3, pointRadius: isMobile ? 3 : 5, pointHoverRadius: isMobile ? 6 : 8, tension: 0.4, fill: true })); chartInstance = new Chart(ctx, { type: 'line', data: { labels, datasets }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { enabled: true, mode: 'index', intersect: false, backgroundColor: 'rgba(0,0,0,0.8)', titleFont: { family: bodyFont, size: 14, weight: 'bold' }, bodyFont: { family: bodyFont, size: 12 }, padding: 12, cornerRadius: 8, displayColors: true, callbacks: { title: tt => tt[0].label, label: c => `${c.dataset.label}: ${c.raw}` } } }, scales: { y: { min: 0, grid: { color: gridColor }, ticks: { color: tickColor, font: { family: bodyFont }, callback: v => { if (Number.isInteger(v)) return v; } } }, x: { type: 'category', grid: { display: false }, ticks: { color: tickColor, font: { family: bodyFont }, maxRotation: 0, minRotation: 0 } } } } }); if (type === 'support') chartInstances.supportLineChart = chartInstance; else chartInstances.totalSupportLineChart = chartInstance; updateLegend(); }; timelineToggle.querySelectorAll('.timeline-btn').forEach(btn => { btn.addEventListener('click', e => { timelineToggle.querySelectorAll('.timeline-btn').forEach(b => b.classList.remove('active')); e.target.classList.add('active'); currentDays = parseInt(e.target.dataset.days); renderChart(); }); }); renderChart(); };
            
            // ATTENDANCE REPORT LOGIC (Correctly Integrated)
            const batchAttendanceManager = {
                container: null, unpivotedData: [], isInitialized: false, chartInstances: {}, selectedProducts: [], selectedDayType: 'Both',
                productColors: { 'ACCA': '#0ea5e9', 'CFA': '#f97316', 'CMA': '#10b981', 'CPA': '#8b5cf6', 'DipIFRS': '#d946ef', 'ESG': '#ec4899', 'FRM': '#14b8a6', 'IB': '#facc15', 'Default': '#9ca3af' },
                init: function(container, rawData) { this.container = container; if (!rawData) { showError(container, "Attendance data missing. Check Apps Script and sheet name."); return; } this.processData(rawData); this.renderLayout(); this.populateFilters(); this.bindEvents(); this.renderAll(); this.isInitialized = true; },
                processData: function(rawData) { if (!rawData || rawData.length < 2) { this.unpivotedData = []; return; } const headerRow = rawData[0], dateColumns = []; for (let i = 5; i < headerRow.length; i++) { const dateVal = String(headerRow[i] || '').trim(); if (dateVal) { const parts = dateVal.split('/'); if (parts.length === 3) { let year = parseInt(parts[2], 10); if (year < 100) year += 2000; const parsedDate = new Date(Date.UTC(year, parseInt(parts[1], 10) - 1, parseInt(parts[0], 10))); if (!isNaN(parsedDate.getTime())) dateColumns.push({ index: i, date: parsedDate }); } } } const flatData = []; for (let i = 1; i < rawData.length; i++) { const row = rawData[i], program = row[0], batchName = row[1], dayType = row[2], enrolled = parseInt(row[3], 10), avgAttendance = parseFloat(String(row[4]).replace('%', '')); if (!program || !batchName) continue; if (!isNaN(avgAttendance)) flatData.push({ program, batchName, enrolled, dayType, isOverall: true, attendancePct: avgAttendance }); dateColumns.forEach(col => { const dailyPct = parseFloat(String(row[col.index] || '').replace('%', '').trim()); if (!isNaN(dailyPct)) { const presentCount = !isNaN(enrolled) && enrolled > 0 ? Math.round((dailyPct / 100) * enrolled) : 0; flatData.push({ program, batchName, enrolled, date: col.date, present: presentCount, attendancePct: dailyPct, dayType }); } }); } this.unpivotedData = flatData; this.selectedProducts = [...new Set(this.unpivotedData.map(d => d.program))]; },
                renderLayout: function() { this.container.innerHTML = `<div class="space-y-8"><div class="metric-card no-hover-pop p-6 md:p-8"><h2 class="text-2xl md:text-3xl font-bold text-[var(--text-color)] text-center mb-6">Yesterday's Attendance</h2><div id="att-yesterday-attendance" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div></div><div class="metric-card no-hover-pop p-6 md:p-8"><h2 class="text-2xl md:text-3xl font-bold text-[var(--text-color)] mb-6">Top Product Performance</h2><div id="att-product-ranking" class="grid grid-cols-1 lg:grid-cols-2 gap-4"></div></div><div class="metric-card no-hover-pop p-6 md:p-8"><h2 class="text-2xl md:text-3xl font-bold text-[var(--text-color)] mb-6">Lowest 5 Batch Performances</h2><div id="att-worst-batches" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-6"></div></div><div class="metric-card no-hover-pop p-6 md:p-8"><h2 class="text-2xl md:text-3xl font-bold text-[var(--text-color)] text-center">Deeper Dive</h2><div class="space-y-8 mt-6"><div class="bg-[var(--sub-box-bg)] p-6 rounded-2xl"><h3 class="text-lg font-bold text-[var(--text-color)] opacity-90 text-center mb-6">Daily Attendance Trend</h3><div class="bg-black/20 rounded-2xl p-4 flex flex-col md:flex-row justify-around items-center gap-6 mb-6"><div><label class="block text-xs font-semibold text-center text-[var(--text-muted-color)] mb-2 uppercase tracking-wider">Batch Type</label><div id="att-day-type-toggle" class="timeline-toggle bg-black/20 rounded-full p-1 flex flex-wrap justify-center gap-1"><button data-day-type="Both" class="timeline-btn px-4 py-1.5 text-sm font-semibold rounded-full active">Both</button><button data-day-type="Weekday" class="timeline-btn px-4 py-1.5 text-sm font-semibold rounded-full">Weekday</button><button data-day-type="Weekend" class="timeline-btn px-4 py-1.5 text-sm font-semibold rounded-full">Weekend</button></div></div><div><label class="block text-xs font-semibold text-center text-[var(--text-muted-color)] mb-2 uppercase tracking-wider">Timeline</label><div id="att-daily-timeline-toggle" class="timeline-toggle bg-black/20 rounded-full p-1 flex flex-wrap justify-center gap-1"><button data-days="7" class="timeline-btn px-4 py-1.5 text-sm font-semibold rounded-full">7 Days</button><button data-days="14" class="timeline-btn px-4 py-1.5 text-sm font-semibold rounded-full active">14 Days</button><button data-days="30" class="timeline-btn px-4 py-1.5 text-sm font-semibold rounded-full">30 Days</button></div></div><div><label class="block text-xs font-semibold text-center text-[var(--text-muted-color)] mb-2 uppercase tracking-wider">Product</label><div id="att-trend-toggles" class="timeline-toggle bg-black/20 rounded-full p-1 flex flex-wrap justify-center gap-1"></div></div></div><div class="min-h-[350px]"><canvas id="att-trendChartCanvas"></canvas></div></div><div class="bg-[var(--sub-box-bg)] p-6 rounded-2xl"><h3 id="att-comparison-title" class="text-lg font-bold text-[var(--text-color)] opacity-90 text-center mb-4">Batch Performance Comparison</h3><div id="att-comparison-header" class="flex flex-wrap items-center justify-center gap-y-4 gap-x-6 mb-6"><div id="att-comparison-toggles" class="timeline-toggle bg-black/20 rounded-full p-1 flex flex-wrap justify-center gap-1"></div></div><div class="min-h-[350px] relative"><canvas id="att-comparisonChartCanvas"></canvas><div id="att-comparison-prompt" class="absolute inset-0 flex items-center justify-center text-center p-4"><div class="bg-[var(--card-bg)] p-6 rounded-2xl text-[var(--text-muted-color)]"><i class="fas fa-mouse-pointer text-4xl mb-4"></i><p>Please select a product from the toggles above to view batch comparisons.</p></div></div></div></div></div></div></div>`; },
                populateFilters: function() { const uniqueProducts = [...new Set(this.unpivotedData.map(d => d.program))].sort(); const trendToggles = document.getElementById('att-trend-toggles'); const comparisonToggles = document.getElementById('att-comparison-toggles'); trendToggles.innerHTML = ['All', ...uniqueProducts].map(p => `<button data-product="${p}" class="timeline-btn px-4 py-1.5 text-sm font-semibold rounded-full flex items-center gap-2"><span class="w-3 h-3 rounded-full" style="background-color: ${p==='All'?'transparent':this.productColors[p]||this.productColors.Default}"></span>${p}</button>`).join(''); comparisonToggles.innerHTML = uniqueProducts.map(p => `<button data-product="${p}" class="timeline-btn px-4 py-1.5 text-sm font-semibold rounded-full">${p}</button>`).join(''); },
                bindEvents: function() { const updateTrend = () => this.renderTrendChart(); document.getElementById('att-trend-toggles').addEventListener('click', e => { const btn = e.target.closest('.timeline-btn'); if (btn) { document.querySelectorAll('#att-trend-toggles .timeline-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); updateTrend(); } }); document.getElementById('att-daily-timeline-toggle').addEventListener('click', e => { const btn = e.target.closest('.timeline-btn'); if (btn) { document.querySelectorAll('#att-daily-timeline-toggle .timeline-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); updateTrend(); } }); document.getElementById('att-day-type-toggle').addEventListener('click', e => { const btn = e.target.closest('.timeline-btn'); if (btn) { document.querySelectorAll('#att-day-type-toggle .timeline-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); updateTrend(); } }); document.getElementById('att-comparison-toggles').addEventListener('click', e => { const btn = e.target.closest('.timeline-btn'); if (btn) { document.querySelectorAll('#att-comparison-toggles .timeline-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); this.renderComparisonChart(); } }); },
                renderAll: function() { if (this.unpivotedData.length === 0) { showError(this.container, "No valid attendance data could be processed."); return; } this.renderYesterdayAttendance(); this.renderProductRanking(); this.renderWorstBatches(); document.querySelectorAll('#att-trend-toggles .timeline-btn, #att-comparison-toggles .timeline-btn, #att-day-type-toggle .timeline-btn').forEach(b => b.classList.remove('active')); document.querySelector('#att-trend-toggles [data-product="All"]')?.classList.add('active'); document.querySelector('#att-day-type-toggle [data-day-type="Both"]')?.classList.add('active'); document.querySelector('#att-daily-timeline-toggle [data-days="14"]')?.classList.add('active'); this.renderTrendChart(); this.renderComparisonChart(); },
                renderYesterdayAttendance: function() { const container = document.getElementById('att-yesterday-attendance'); const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1); const yesterdayUTC = new Date(Date.UTC(yesterday.getUTCFullYear(), yesterday.getUTCMonth(), yesterday.getUTCDate())); const lectures = this.unpivotedData.filter(d => d.date && d.date.getTime() === yesterdayUTC.getTime()); if (lectures.length === 0) { container.innerHTML = `<div class="col-span-full text-center p-8 text-[var(--text-muted-color)] bg-[var(--sub-box-bg)] rounded-2xl">No lectures were scheduled for yesterday.</div>`; return; } container.innerHTML = lectures.map(l => { const cs = getPerformanceColorState(l.attendancePct); return `<div class="small-metric-card metric-card p-4 flex flex-col items-center text-center space-y-2 rounded-2xl" data-color-state="${cs}"><div class="font-semibold text-base text-[var(--text-color)] truncate w-full" title="${l.batchName}">${l.batchName}</div><div class="text-4xl font-bold ${getPerformanceColorClass(cs)} tracking-tight">${l.attendancePct.toFixed(0)}%</div><div class="text-xs text-[var(--text-muted-color)]">${l.present} / ${l.enrolled} Present</div></div>`; }).join(''); },
                renderProductRanking: function() { const container = document.getElementById('att-product-ranking'); const overallData = this.unpivotedData.filter(d => d.isOverall); if (overallData.length === 0) { container.innerHTML = `<div class="col-span-full text-center p-8 text-[var(--text-muted-color)] bg-[var(--sub-box-bg)] rounded-2xl">No overall product data available.</div>`; return; } const byProgram = overallData.reduce((acc, curr) => { if (!acc[curr.program]) acc[curr.program] = { total: 0, count: 0 }; acc[curr.program].total += curr.attendancePct; acc[curr.program].count++; return acc; }, {}); const ranked = Object.keys(byProgram).map(p => ({ name: p, avg: byProgram[p].total / byProgram[p].count })).sort((a,b) => b.avg - a.avg); container.innerHTML = ranked.map((p, i) => `<div class="product-rank-item"><div class="product-rank-number">#${i + 1}</div><div class="product-rank-details flex items-baseline justify-start gap-4"><span class="text-xl font-bold text-[var(--text-color)]">${p.name}</span><span class="text-2xl font-bold ${getPerformanceColorClass(getPerformanceColorState(p.avg))} tracking-tight">${p.avg.toFixed(0)}%</span></div></div>`).join(''); },
                renderWorstBatches: function() { const container = document.getElementById('att-worst-batches'); const overallData = this.unpivotedData.filter(d => d.isOverall); if (overallData.length === 0) { container.innerHTML = `<div class="col-span-full text-center p-8 text-[var(--text-muted-color)] bg-[var(--sub-box-bg)] rounded-2xl">No data to rank worst batches.</div>`; return; } const worst = overallData.sort((a,b) => a.attendancePct - b.attendancePct).slice(0, 5); container.innerHTML = worst.map(b => { const cs = getPerformanceColorState(b.attendancePct); return `<div class="small-metric-card metric-card p-4 flex flex-col items-center justify-center text-center space-y-1 rounded-2xl" data-color-state="${cs}"><div class="font-semibold text-sm text-[var(--text-color)] h-12 flex items-center justify-center text-center">${b.batchName}</div><div class="text-4xl font-bold ${getPerformanceColorClass(cs)} tracking-tight">${b.attendancePct.toFixed(0)}%</div><div class="text-xs text-[var(--text-muted-color)]">Avg Attendance</div></div>`; }).join(''); },
                renderTrendChart: function() { const days = parseInt(document.querySelector('#att-daily-timeline-toggle .active')?.dataset.days || '14'); const dayType = document.querySelector('#att-day-type-toggle .active')?.dataset.dayType || 'Both'; const activeProdBtn = document.querySelector('#att-trend-toggles .active'); const selProds = activeProdBtn && activeProdBtn.dataset.product !== 'All' ? [activeProdBtn.dataset.product] : [...new Set(this.unpivotedData.map(d=>d.program))]; const today = new Date(); today.setUTCHours(23, 59, 59, 999); let filtered = this.unpivotedData.filter(d => !d.isOverall && selProds.includes(d.program) && d.date <= today); if (dayType !== 'Both') filtered = filtered.filter(d => d.dayType === dayType); const byDate = filtered.reduce((acc, curr) => { const dateKey = curr.date.toISOString().slice(0, 10); if (!acc[dateKey]) acc[dateKey] = {}; if (!acc[dateKey][curr.program]) acc[dateKey][curr.program] = { total: 0, count: 0 }; acc[dateKey][curr.program].total += curr.attendancePct; acc[dateKey][curr.program].count++; return acc; }, {}); let sortedDates = Object.keys(byDate).sort((a,b) => new Date(a) - new Date(b)); if(sortedDates.length > days) sortedDates = sortedDates.slice(-days); const datasets = selProds.map(p => ({ label: p, data: sortedDates.map(d => { const pData = byDate[d]?.[p]; return pData && pData.count > 0 ? pData.total / pData.count : null; }), borderColor: this.productColors[p] || this.productColors.Default, backgroundColor: (this.productColors[p] || this.productColors.Default) + '1A', fill: true, tension: 0.3, borderWidth: 2 })); this.createChart('att-trendChartCanvas', 'line', { labels: sortedDates, datasets }, { scales: { y: { min: 0, max: 100, ticks: { callback: v => Math.round(v) + '%' } }, x: { type: 'time', time: { unit: 'day', tooltipFormat: 'MMM d' } } }, plugins: { legend: { display: false }, tooltip: { callbacks: { label: c => `${c.dataset.label}: ${c.parsed.y.toFixed(2)}%` } } } }); },
                renderComparisonChart: function() { const selProd = document.querySelector('#att-comparison-toggles .active')?.dataset.product; const prompt = document.getElementById('att-comparison-prompt'), canvas = document.getElementById('att-comparisonChartCanvas'), header = document.getElementById('att-comparison-title'); if (!selProd) { prompt.classList.remove('hidden'); canvas.classList.add('hidden'); if(header) header.textContent = 'Batch Performance Comparison'; if (this.chartInstances['att-comparisonChartCanvas']) { this.chartInstances['att-comparisonChartCanvas'].destroy(); } return; } prompt.classList.add('hidden'); canvas.classList.remove('hidden'); if(header) header.textContent = `${selProd} Batch Performance`; const batchData = this.unpivotedData.filter(d => d.isOverall && d.program === selProd); if (batchData.length === 0) { this.createChart('att-comparisonChartCanvas', 'bar', { labels: [], datasets: [] }, {}); return; } const sorted = batchData.sort((a, b) => a.attendancePct - b.attendancePct); const datasets = [{ label: 'Avg Attendance', data: sorted.map(b => b.attendancePct), backgroundColor: sorted.map(b => { const s = getPerformanceColorState(b.attendancePct); return s==='good'?'rgba(34,197,94,0.8)':s==='medium'?'rgba(245,158,11,0.8)':'rgba(239,68,68,0.8)'; }), borderWidth: 0 }]; this.createChart('att-comparisonChartCanvas', 'bar', { labels: sorted.map(b => b.batchName), datasets }, { indexAxis: 'y', scales: { x: { min: 0, max: 100, ticks: { callback: v => v + '%' } } }, onHover: (e, el, chart) => { chart.canvas.style.cursor = el.length ? 'pointer' : 'default'; chart.data.datasets.forEach(ds => { ds.backgroundColor = ds.data.map((_, i) => { const s = getPerformanceColorState(sorted[i].attendancePct); const base = s==='good'?'rgba(34,197,94,':s==='medium'?'rgba(245,158,11,':'rgba(239,68,68,'; const op = (el.length === 0 || el[0].index === i) ? '0.8)' : '0.2)'; return base + op; }); }); chart.update('none'); }, plugins: { legend: { display: false }, tooltip: { displayColors: false, callbacks: { title: () => null, label: c => `${c.parsed.x.toFixed(2)}%` } } } }); },
                createChart(id, type, data, options) { if (this.chartInstances[id]) this.chartInstances[id].destroy(); const canvas = document.getElementById(id); if(!canvas) return; const ctx = canvas.getContext('2d'), isLight = document.body.classList.contains('light-mode'), gridColor = isLight ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.1)', textColor = isLight ? '#333' : '#ddd'; this.chartInstances[id] = new Chart(ctx, { type, data, options: { responsive: true, maintainAspectRatio: false, ...options, scales: {...options.scales, y: { ...options.scales.y, grid: { color: gridColor }, ticks: { color: textColor, ...options.scales?.y?.ticks } }, x: { ...options.scales.x, grid: { color: gridColor }, ticks: { color: textColor, ...options.scales?.x?.ticks } } }, plugins: { ...options.plugins, legend: { ...options.plugins?.legend, labels: { color: textColor } }, tooltip: { ...options.plugins?.tooltip, bodyFont: { family: "'Inter', sans-serif" }, titleFont: { family: "'Inter', sans-serif" } } } } }); }
            };

            const renderReportsPage = (container) => {
                const reports = [
                    { title: 'LMS Web & App Metrics', icon: 'fas fa-chart-line', id: 'show-daily-metrics-btn' },
                    { title: 'LMS Checks', icon: 'fas fa-clipboard-check', id: 'show-course-checks-btn' },
                    { title: 'Question Repository', icon: 'fas fa-book-open', id: 'show-question-repo-btn' },
                    { title: 'Ask a Doubt + LMS Tickets', icon: 'fas fa-headset', id: 'show-ask-a-doubt-btn' },
                    { title: 'Weekly Batch Reports', icon: 'fas fa-chart-pie', id: 'show-batch-reports-btn' },
                    { title: 'Attendance Report', icon: 'fas fa-user-check', id: 'show-attendance-btn' },
                ];
                container.innerHTML = `<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">${reports.map(report => `<button id="${report.id}" class="report-tile rounded-3xl p-6 flex flex-col items-center justify-center text-center aspect-[4/3]"><div class="report-tile-icon text-6xl mb-4"><i class="${report.icon}"></i></div><h3 class="text-xl font-bold text-[var(--text-color)]">${report.title}</h3></button>`).join('')}</div>`;
            };

            // --- Navigation & UI Flow ---
            const updateGreeting = () => { const greetingText = document.getElementById('greeting-text'), dateText = document.getElementById('date-text'), hour = new Date().getHours(); if (hour < 12) greetingText.textContent = 'Good Morning'; else if (hour < 18) greetingText.textContent = 'Good Afternoon'; else greetingText.textContent = 'Good Evening'; dateText.textContent = new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' }); setTimeout(() => headerGreeting.style.opacity = '1', 200); };
            const updateFooterText = (sectionId) => { const footerContent = document.getElementById('footer-content'); if (!footerContent) return; const texts = { 'overview-section': 'Showing important data from all Product Report Sheets.', 'reports-section': 'Select any report you want to view.', 'daily-section': 'Data here is updated every Friday for the week.', 'course-checks-section': 'Data is updated whenever any batch setup is completed by the Acads Team.', 'question-repo-section': 'Data is usually updated on every weekday by the first half.', 'ask-a-doubt-section': 'Data is updated every weekday by evening.', 'batch-reports-section': 'Data is updated on a weekly basis, usually by every Tuesday.', 'attendance-section': 'Attendance data is synced periodically from the master sheet.' }; footerContent.textContent = texts[sectionId] || ''; };
            const setPageHeader = (title, sheetUrl) => { pageHeaderCenterContent.innerHTML = `<h1 id="page-header-title" class="text-xl md:text-2xl font-bold text-[var(--text-color)] truncate"></h1>`; pageHeaderCenterContent.className = 'bg-[var(--header-bg)] backdrop-blur-lg border border-[var(--header-border)] rounded-full flex items-center justify-center px-4 md:px-8 py-3 mx-auto'; if (title !== null) { document.getElementById('page-header-title').textContent = title; pageHeader.classList.remove('hidden'); pageHeader.classList.add('flex'); mainHeader.classList.add('hidden'); const activeSection = Array.from(pageContents).find(s => !s.classList.contains('hidden')); if (activeSection && activeSection.id !== 'reports-section' && activeSection.id !== 'question-repo-section') headerRefreshButton.classList.remove('hidden'); else headerRefreshButton.classList.add('hidden'); if (sheetUrl) { openSheetButton.href = sheetUrl; openSheetButton.classList.remove('hidden'); } else { openSheetButton.classList.add('hidden'); } } else { pageHeader.classList.add('hidden'); pageHeader.classList.remove('flex'); mainHeader.classList.remove('hidden'); openSheetButton.classList.add('hidden'); headerRefreshButton.classList.add('hidden'); } };
            const switchTab = async (tabId) => { setPageHeader(null); navButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.tab === tabId)); pageContents.forEach(c => c.classList.add('hidden')); const activeContent = document.getElementById(`${tabId}-section`); activeContent.classList.remove('hidden'); updateFooterText(`${tabId}-section`); if (tabId === 'overview') renderOverviewPage(activeContent, dataCache); else if (tabId === 'reports') renderReportsPage(document.getElementById('reports-section')); };
            const showDailyMetrics = () => { pageContents.forEach(c=>c.classList.add('hidden')); const s = document.getElementById('daily-section'); s.classList.remove('hidden'); const t = window.innerWidth<768?'LMS Metrics':'LMS Web & App Metrics'; setPageHeader(t, SHEET_URLS['daily-section']); updateFooterText('daily-section'); if (dataCache.daily_metrics) renderDailyMetricsPage(s, dataCache.daily_metrics); else showError(s, "Daily metrics data not found."); };
            const showCourseChecksPage = () => { pageContents.forEach(c=>c.classList.add('hidden')); const s = document.getElementById('course-checks-section'); s.classList.remove('hidden'); setPageHeader('LMS Checks', SHEET_URLS['course-checks-section']); updateFooterText('course-checks-section'); if(dataCache.lms_course_checks) renderCourseChecksPage(s, {parsed: parseAsHeaders(dataCache.lms_course_checks), raw: dataCache.lms_course_checks}); else showError(s, "LMS checks data not found."); };
            const showQuestionRepo = () => { pageContents.forEach(c=>c.classList.add('hidden')); const s = document.getElementById('question-repo-section'); s.classList.remove('hidden'); updateFooterText('question-repo-section'); setPageHeader('', SHEET_URLS['question-repo-section']); const nav = document.createElement('nav'); nav.id = 'qrf-navigation-bar-sticky'; nav.className='flex justify-center items-center gap-1'; nav.innerHTML = `<button data-qrf-tab="acca" class="nav-item qrf-nav-item px-3 md:px-6 py-2 text-sm md:text-base font-semibold rounded-full">ACCA</button><button data-qrf-tab="cfa" class="nav-item qrf-nav-item px-3 md:px-6 py-2 text-sm md:text-base font-semibold rounded-full">CFA</button><button data-qrf-tab="overall" class="nav-item qrf-nav-item px-3 md:px-6 py-2 text-sm md:text-base font-semibold rounded-full">Overall</button>`; pageHeaderCenterContent.innerHTML=''; pageHeaderCenterContent.className='bg-[var(--header-bg)] backdrop-blur-lg border border-[var(--header-border)] rounded-full p-2'; pageHeaderCenterContent.appendChild(nav); const navItems = nav.querySelectorAll('.qrf-nav-item'); const switchQrf = (id) => { document.querySelectorAll('.qrf-content-section').forEach(sec => sec.classList.add('hidden')); document.getElementById(`${id}-qrf-content`)?.classList.remove('hidden'); navItems.forEach(item => { item.classList.remove('active'); if(item.dataset.qrfTab === id) item.classList.add('active'); }); }; nav.addEventListener('click', e => { if(e.target.matches('.qrf-nav-item')) switchQrf(e.target.dataset.qrfTab); }); if(dataCache.qrf_acca && dataCache.qrf_cfa && dataCache.qrf_overall){ const aD={summary:{draft:dataCache.qrf_acca[1][7], approved:dataCache.qrf_acca[3][7], total:dataCache.qrf_acca[4][7], completion:dataCache.qrf_acca[5][7], subjectiveCount:dataCache.qrf_acca[6][7], subjectivePercent:dataCache.qrf_acca[7][7], nonSubjectiveCount:dataCache.qrf_acca[8][7], nonSubjectivePercent:dataCache.qrf_acca[9][7], totalQuestions:dataCache.qrf_acca[10][7]}, daily:parseAsHeaders(dataCache.qrf_acca)}; const cD={summary:{draft:dataCache.qrf_cfa[1][7], approved:dataCache.qrf_cfa[3][7], total:dataCache.qrf_cfa[4][7], completion:dataCache.qrf_cfa[5][7], nonSubjectiveCount:dataCache.qrf_cfa[7][7], nonSubjectivePercent:dataCache.qrf_cfa[8][7], subjectiveCount:dataCache.qrf_cfa[9][7], subjectivePercent:dataCache.qrf_cfa[10][7], totalQuestions:dataCache.qrf_cfa[11][7]}, daily:parseAsHeaders(dataCache.qrf_cfa)}; const oD={summary:{draft:dataCache.qrf_overall[1][7], approved:dataCache.qrf_overall[2][7], total:dataCache.qrf_overall[3][7], completion:dataCache.qrf_overall[4][7]}, daily:parseAsHeaders(dataCache.qrf_overall)}; renderQuestionRepoPage(s, aD, cD, oD); } else { showError(s, "Failed to find QRF data."); } switchQrf('acca'); };
            const showBatchReportsPage = () => { pageContents.forEach(c=>c.classList.add('hidden')); const s = document.getElementById('batch-reports-section'); s.classList.remove('hidden'); setPageHeader('Batch Reports', SHEET_URLS['batch-reports-section']); updateFooterText('batch-reports-section'); if(dataCache.batch_information) renderBatchReportsPage(s, dataCache.batch_information); else showError(s, "Failed to fetch batch reports data."); };
            const showAskADoubtPage = () => { pageContents.forEach(c=>c.classList.add('hidden')); const s = document.getElementById('ask-a-doubt-section'); s.classList.remove('hidden'); setPageHeader('LMS Support', SHEET_URLS['ask-a-doubt-section']); updateFooterText('ask-a-doubt-section'); if(dataCache.aad_lms_tickets) renderAskADoubtPage(s, {'Total Doubts': dataCache.aad_lms_tickets[0][7], 'Open Doubts': dataCache.aad_lms_tickets[1][7], 'Total Support Tickets': dataCache.aad_lms_tickets[2][7], 'Open Support Tickets': dataCache.aad_lms_tickets[3][7]}, dataCache.aad_lms_tickets.slice(1).map(r=>({date:new Date(r[0]), doubts:r[1], tickets:r[2]})).filter(d=>!isNaN(d.date.getTime())&&d.doubts!==''&&d.tickets!==''), dataCache.aad_lms_tickets.slice(1).map(r=>({date:new Date(r[0]), totalDoubts:r[3], totalTickets:r[4]})).filter(d=>!isNaN(d.date.getTime())&&d.totalDoubts!==''&&d.totalTickets!=='')); else showError(s, "Failed to fetch LMS support data."); };
            
            const showReportsList = () => {
                pageContents.forEach(content => content.classList.add('hidden'));
                document.getElementById('reports-section').classList.remove('hidden');
                setPageHeader(null);
                updateFooterText('reports-section');
            };

            const showAttendancePage = () => {
                pageContents.forEach(content => content.classList.add('hidden'));
                const attendanceSection = document.getElementById('attendance-section');
                attendanceSection.classList.remove('hidden');
                setPageHeader('Attendance Report', SHEET_URLS['attendance-section']);
                updateFooterText('attendance-section');
                
                const attendanceData = dataCache.attendance_overview;
                if (attendanceData) {
                    batchAttendanceManager.init(attendanceSection, attendanceData);
                } else {
                    showError(attendanceSection, "Could not load Attendance Report data.");
                }
            };

            const refreshData = async () => { const activeSection = Array.from(pageContents).find(s => !s.classList.contains('hidden')); if (!activeSection) return; showLoading(activeSection); await fetchAllData(true); const mainTabId = document.querySelector('.nav-item.active')?.dataset.tab; if (mainTabId === 'overview' || activeSection.id === 'overview-section') { await switchTab('overview'); } else if (mainTabId === 'reports') { switch(activeSection.id) { case 'batch-reports-section': showBatchReportsPage(); break; case 'daily-section': showDailyMetrics(); break; case 'course-checks-section': showCourseChecksPage(); break; case 'question-repo-section': showQuestionRepo(); break; case 'ask-a-doubt-section': showAskADoubtPage(); break; case 'attendance-section': showAttendancePage(); break; default: showReportsList(); } } };
            const initialLoad = async () => { loadingOverlay.style.opacity = '1'; loadingOverlay.style.pointerEvents = 'auto'; loadingOverlay.style.display = 'flex'; updateGreeting(); const minLoadTime = new Promise(r => setTimeout(r, 2000)), dataFetch = fetchAllData(); const [_, data] = await Promise.all([minLoadTime, dataFetch]); if(data){ header.classList.remove('hidden'); await switchTab('overview'); renderReportsPage(document.getElementById('reports-section')); updateFooterText('overview-section'); } loadingOverlay.style.opacity = '0'; setTimeout(() => { loadingOverlay.style.pointerEvents = 'none'; loadingOverlay.style.display = 'none'; }, 500); };
            navButtons.forEach(b => { if (b.dataset.tab) b.addEventListener('click', () => switchTab(b.dataset.tab)); });
            const handleThemeToggle = () => { document.body.classList.toggle('light-mode'); const activeSection = Array.from(pageContents).find(s => !s.classList.contains('hidden')); if (!activeSection) return; const mainTabId = document.querySelector('.nav-item.active')?.dataset.tab; if (mainTabId === 'reports') { switch(activeSection.id) { case 'batch-reports-section': showBatchReportsPage(); break; case 'daily-section': showDailyMetrics(); break; case 'course-checks-section': showCourseChecksPage(); break; case 'question-repo-section': showQuestionRepo(); break; case 'ask-a-doubt-section': showAskADoubtPage(); break; case 'attendance-section': showAttendancePage(); break; } } };
            themeToggleDesktop.addEventListener('click', handleThemeToggle); themeToggleMobile.addEventListener('click', handleThemeToggle);
            headerBackButton.addEventListener('click', showReportsList);
            mainContent.addEventListener('click', e => { const t = e.target.closest('button'); if (!t) return; const actions = {'show-daily-metrics-btn':showDailyMetrics, 'show-question-repo-btn':showQuestionRepo, 'show-course-checks-btn':showCourseChecksPage, 'show-batch-reports-btn':showBatchReportsPage, 'show-ask-a-doubt-btn':showAskADoubtPage, 'show-attendance-btn':showAttendancePage}; if(actions[t.id]) actions[t.id](); });
            const handleRefreshClick = () => { const icon = mainHeaderRefreshButton.querySelector('i')?.offsetParent ? mainHeaderRefreshButton.querySelector('i') : headerRefreshButton.querySelector('i'); if (!icon || icon.classList.contains('animate-spin')) return; icon.classList.add('animate-spin'); Promise.all([refreshData(), new Promise(r => setTimeout(r, 750))]).finally(() => icon.classList.remove('animate-spin')); };
            headerRefreshButton.addEventListener('click', handleRefreshClick); mainHeaderRefreshButton.addEventListener('click', handleRefreshClick);
            mainContent.addEventListener('scroll', () => { const { scrollTop, scrollHeight, clientHeight } = mainContent; document.getElementById('page-footer').classList.toggle('visible', scrollHeight - scrollTop <= clientHeight + 50); if (headerGreeting) headerGreeting.style.opacity = (scrollTop > 20) ? '0' : '1'; });
            let currentPasscode = ''; const updatePasscodeDots = () => { passcodeDots.querySelectorAll('.passcode-dot').forEach((dot, i) => { dot.classList.toggle('filled', i < currentPasscode.length); dot.classList.remove('success'); }); };
            const handlePasscodeEntry = (key) => { if (key === 'backspace') currentPasscode = currentPasscode.slice(0, -1); else if (currentPasscode.length < 4) currentPasscode += key; updatePasscodeDots(); if (currentPasscode.length === 4) { if (currentPasscode === CORRECT_PASSCODE) { passcodeDots.querySelectorAll('.passcode-dot').forEach(d => d.classList.add('success')); setTimeout(() => { passcodeContainer.style.opacity = '0'; passcodeContainer.style.transform = 'scale(0.9)'; }, 100); setTimeout(() => { passcodeOverlay.style.opacity = '0'; passcodeOverlay.style.pointerEvents = 'none'; initialLoad(); }, 400); } else { passcodeDots.classList.add('shake'); passcodeError.textContent = 'Incorrect Passcode'; setTimeout(() => { passcodeDots.classList.remove('shake'); passcodeError.textContent = ''; currentPasscode = ''; updatePasscodeDots(); }, 800); } } };
            passcodeKeypad.addEventListener('click', e => { const key = e.target.closest('.passcode-keypad-btn')?.dataset.key; if (key) handlePasscodeEntry(key); });
            document.addEventListener('keydown', e => { if (passcodeOverlay.style.pointerEvents !== 'none') { if (e.key >= '0' && e.key <= '9') handlePasscodeEntry(e.key); else if (e.key === 'Backspace') handlePasscodeEntry('backspace'); } });
        });
    </script>
</body>
</html>

