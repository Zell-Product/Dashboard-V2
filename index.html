<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fintech QC Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
         :root {
            /* Graphite Theme */
            --bg-color: #e5e5ea;
            --text-color: #1c1c1e;
            --text-muted-color: #3a3a3c;
            --card-bg: rgba(242, 242, 247, 0.85);
            --card-border: rgba(0, 0, 0, 0.08);
            --header-bg: rgba(235, 235, 240, 0.85);
            --header-border: rgba(0, 0, 0, 0.09);
            --sub-box-bg: rgba(229, 229, 234, 0.8);
            --accent-color: #5856d6; /* iOS Purple */
            --button-text: #000000;
            --button-bg: #ffffff;
            --button-border: rgba(0, 0, 0, 0.08);
            --button-hover-bg: rgba(0, 0, 0, 0.04);
            --button-disabled-bg: #f2f2f7;
            --button-disabled-text: #aeaeb2;
            --button-disabled-border: #d1d5db;
            --good-tint: rgba(48, 209, 88, 0.15);
            --medium-tint: rgba(255, 159, 10, 0.15);
            --bad-tint: rgba(255, 69, 58, 0.15);
             --good-text: #1a8a4d;
             --medium-text: #b45309;
             --bad-text: #c53030;
            --spinner-color: var(--accent-color);
            --header-height: 64px; /* Slightly reduced header height */
        }
        html {
            scroll-behavior: smooth;
            height: 100%; /* ADDED */
            overflow: hidden; /* ADDED */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            padding-top: var(--header-height);
            display: flex; /* REQUIRED */
            flex-direction: column; /* REQUIRED */
            /* min-height: 100vh; CHANGED */
            height: 100%; /* CHANGED */
            overflow: hidden; /* Prevent body scroll */
            /* Added transition for padding change */
            transition: padding-top 0.3s ease;
         }
         body::-webkit-scrollbar { width: 8px; }
        body::-webkit-scrollbar-track { background: transparent; }
        body::-webkit-scrollbar-thumb { background-color: rgba(0, 0, 0, 0.2); border-radius: 10px; }

        .hidden { display: none; }
        .fa-sync-alt.animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

         /* Glassy Sticky Header */
        #appHeader {
            position: sticky; top: 0; left: 0; right: 0; z-index: 50;
            background-color: var(--header-bg);
            backdrop-filter: blur(20px) saturate(180%); -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 1px solid var(--header-border);
            height: var(--header-height); padding: 0 1rem; flex-shrink: 0;
            display: flex; align-items: center; justify-content: space-between;
        }
         @media (min-width: 768px) { #appHeader { padding: 0 2rem; } }

         /* Main content container - CRITICAL FOR LAYOUT */
         #appContainer {
             flex-grow: 1; /* REQUIRED: Allow container to take remaining space */
             display: flex; /* REQUIRED */
             flex-direction: column; /* REQUIRED */
             width: 100%; max-width: 1152px; /* max-w-6xl */
             margin-left: auto; margin-right: auto;
             padding-left: 1rem; padding-right: 1rem; padding-bottom: 2rem;
             opacity: 0; transition: opacity 0.5s ease, max-width 0.3s ease, padding 0.3s ease; /* Added transitions */
             min-height: 0; /* REQUIRED: Prevent flex item overflow */
             overflow-y: auto; /* Allow scrolling ONLY within this container */
         }
          @media (min-width: 768px) { #appContainer { padding-left: 2rem; padding-right: 2rem;} }

        .metric-card, .sub-box {
            border-radius: 1.5rem; transition: all 0.3s ease;
            border: 1px solid var(--card-border); background-color: var(--card-bg);
            backdrop-filter: blur(20px) saturate(180%); -webkit-backdrop-filter: blur(20px) saturate(180%);
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
        }
         /* Page content - CRITICAL FOR LAYOUT */
        .page-content {
             padding-top: 1.5rem; /* Reduced top padding */
             padding-bottom: 0; /* Remove bottom padding */
             flex-grow: 1; /* REQUIRED: Allow page content to grow */
             display: flex; flex-direction: column;
             min-height: 0; /* REQUIRED: Prevent flex item overflow */
         }

        /* Accordion Styles */
        .book-card {
             background: var(--card-bg); border: 1px solid var(--card-border);
             border-radius: 1.5rem; margin-bottom: 1.5rem;
             box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06); overflow: hidden;
             flex-shrink: 0;
        }
        .book-header, .module-header {
            padding: 1rem 1.5rem; cursor: pointer; transition: background-color 0.2s ease;
            display: flex; justify-content: space-between; align-items: center;
        }
        .book-header { border-bottom: 1px solid var(--card-border); }
        .book-header:hover, .module-header:hover { background-color: var(--button-hover-bg); }
        .book-title, .module-title { font-size: 1.1rem; font-weight: 600; color: var(--text-color); }
        .chevron { transition: transform 0.3s ease; color: var(--text-muted-color); }
        .rotate-180 { transform: rotate(180deg); }
        .book-content, .module-content {
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1), padding 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 0; overflow: hidden; background-color: var(--sub-box-bg); padding: 0 1rem;
        }
        .book-content.open, .module-content.open { max-height: 10000px; padding: 1rem; }
        .module-card {
            background: var(--card-bg); border: 1px solid var(--card-border);
            border-radius: 1rem; margin-bottom: 1rem; overflow: hidden;
        }

        /* Table Styles */
        .chapter-table { width: 100%; border-collapse: separate; border-spacing: 0; }
        .chapter-table th, .chapter-table td { padding: 0.8rem 1rem; text-align: left; border-bottom: 1px solid var(--card-border); font-size: 0.875rem; }
        .chapter-table th { background-color: transparent; color: var(--text-muted-color); font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; font-size: 0.75rem; border-bottom-width: 1px; }
        .chapter-table tbody tr { transition: background-color 0.15s ease-in-out; }
        .chapter-table tbody tr:hover { background-color: var(--button-hover-bg); }
        .chapter-table td:first-child { border-top-left-radius: 0.75rem; border-bottom-left-radius: 0.75rem; }
        .chapter-table td:last-child { border-top-right-radius: 0.75rem; border-bottom-right-radius: 0.75rem; }
         .chapter-table tbody tr:last-child td { border-bottom: none; }
        .status-pill { font-size: 0.7rem; font-weight: 700; padding: 0.2rem 0.6rem; border-radius: 99px; display: inline-block; text-transform: uppercase; letter-spacing: 0.5px; }
        .status-done { background-color: var(--good-tint); color: var(--good-text); border: 1px solid var(--good-text); }
        .status-pending { background-color: rgba(0,0,0,0.05); color: var(--text-muted-color); border: 1px solid rgba(0,0,0,0.1); }
        .view-report-button {
             font-weight: 600; padding: 0.4rem 0.8rem; border-radius: 0.5rem; transition: all 0.2s ease; cursor: pointer;
             display: inline-flex; align-items: center; justify-content: center; border: 1px solid transparent;
             background-color: var(--accent-color); color: white; font-size: 0.75rem;
             box-shadow: 0 2px 8px rgba(88, 86, 214, 0.15);
        }
        .view-report-button:hover:not(:disabled) { background-color: #4341a4; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(88, 86, 214, 0.2); }
        .no-report-span { background-color: #e5e7eb; color: #4b5563; font-size: 0.75rem; font-weight: 600; padding: 0.4rem 0.8rem; border-radius: 0.5rem; cursor: not-allowed; display: inline-block; }

        /* Report Viewer Styles - CRITICAL FOR LAYOUT */
        .page { display: none; }
        .page.active { display: block; flex-grow: 1; display: flex; flex-direction: column; } /* Ensure active page grows */
         #page-report-viewer {
             padding-top: 0; /* MODIFIED: was 1.5rem via .page-content, now 0 */
             flex-grow: 1; /* Allow this page to grow */
             display: flex; /* Use flex */
             flex-direction: column;
         }
         #page-report-viewer > .report-viewer-inner-container { /* Target the inner flex container */
              flex-grow: 1; /* Allow inner container to grow */
              min-height: 0; /* Prevent overflow issues in flex children */
              display: flex; /* Ensure it's also a flex container */
              flex-direction: column;
         }
        .report-viewer-header {
             display: flex; align-items: center; justify-content: space-between;
             padding: 0.5rem 1rem; /* CHANGED: Was 0.75rem 0. Moves to top, adds horizontal padding */
             flex-shrink: 0;
             height: auto; /* CHANGED: Was 48px. Let padding define height. */
             box-sizing: border-box; /* ADDED: For accurate padding calculation */
         }
        .report-iframe-wrapper {
            flex-grow: 1; border-radius: 1rem; overflow: hidden;
            background-color: #fff; border: 1px solid var(--card-border);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.07);
            /* display: flex; align-items: center; justify-content: center; <-- REMOVED */
            position: relative;
            min-height: 0; /* Prevent overflow */
            transition: all 0.3s ease; /* ADDED: For smooth transition */
        }
        .report-iframe-wrapper .iframe-loader {
             position: absolute; inset: 0; display: flex; align-items: center; justify-content: center;
             background-color: #fff; z-index: 10;
        }
        .report-iframe { width: 100%; height: 100%; border: none; }


         /* === EXACT Glassy Button Styles from Product Dashboard Light Mode === */
         .glassy-button {
             background-color: var(--button-bg); color: var(--text-color); border: 1px solid var(--button-border);
             box-shadow: 0 1px 2px rgba(0,0,0,0.05), inset 0 1px 1px rgba(255,255,255,0.7);
             background-image: linear-gradient(to bottom, rgba(255,255,255,0.5), rgba(255,255,255,0.1));
             font-weight: 600; padding: 0.6rem 1rem; border-radius: 9999px;
             transition: all 0.15s ease-out; cursor: pointer; display: inline-flex; align-items: center; justify-content: center;
             height: 40px; box-sizing: border-box; user-select: none; -webkit-user-select: none;
             width: 40px; padding: 0; /* Icon only */
        }
        .glassy-button.with-text {
             width: auto; padding: 0.6rem 1rem;
        }
        .glassy-button:hover:not(:disabled) {
             background-color: var(--button-hover-bg); border-color: rgba(0,0,0,0.1);
             transform: translateY(-1px);
             box-shadow: 0 3px 6px rgba(0,0,0,0.07), inset 0 1px 1px rgba(255,255,255,0.6);
        }
         .glassy-button:active:not(:disabled) {
             transform: translateY(0px);
             box-shadow: 0 1px 1px rgba(0,0,0,0.05), inset 0 1px 1px rgba(255,255,255,0.7);
             background-color: rgba(0,0,0,0.03);
             transition-duration: 0.05s;
         }
        .glassy-button:disabled {
             background-color: var(--button-disabled-bg); color: var(--button-disabled-text); border-color: var(--button-disabled-border);
             box-shadow: none; background-image: none; cursor: not-allowed; opacity: 0.7;
        }
        .glassy-button .spinner { display: none; width: 1em; height: 1em; border: 2px solid transparent; border-top-color: currentColor; border-radius: 50%; animation: spin 1s linear infinite; margin-left: 0.5rem; }
        .glassy-button:disabled .spinner { display: inline-block; color: var(--button-disabled-text);}
        .back-button i { margin: 0; font-size: 1.1rem; }
        .refresh-btn i { margin: 0; font-size: 1.1rem; }
         /* --- End Glassy Button Styles --- */


        /* === Updated Loading Screen Styles === */
         .full-page-loader {
             display: flex; align-items: center; justify-content: center; height: 100vh; flex-direction: column;
             background-color: var(--bg-color); position: fixed; inset: 0; z-index: 2000;
             transition: opacity 0.5s ease-in-out;
             opacity: 1; pointer-events: auto;
         }
         .full-page-loader.hidden { opacity: 0; pointer-events: none; }
         #loading-text-container span {
             opacity: 0; animation: fadeInOut 2s ease-in-out infinite;
             font-size: 1.25rem; font-weight: 500; color: var(--text-muted-color);
         }
         @keyframes fadeInOut { 0%, 100% { opacity: 0; } 50% { opacity: 1; } }
        /* === End Updated Loader === */

         /* Footer - Now explicitly positioned */
        #appFooter {
            margin-top: auto; /* Push footer to bottom */
            color: var(--text-muted-color); font-size: 0.8rem;
            border-top: 1px solid var(--card-border); padding-top: 1.5rem; text-align: center;
            opacity: 0.6;
            flex-shrink: 0; /* Prevent footer from shrinking */
            width: 100%; /* Ensure footer takes full width */
            padding-bottom: 1.5rem; /* Add some bottom padding */
             max-width: 1152px; /* Match app container width */
             margin-left: auto; margin-right: auto; /* Center within flex */
             padding-left: 1rem; padding-right: 1rem;
             box-sizing: border-box; /* Include padding in width */
        }
          @media (min-width: 768px) { #appFooter { padding-left: 2rem; padding-right: 2rem;} }
         /* Hide footer when report page is active */
         #page-report-viewer.active ~ #appFooter { display: none; }


        /* --- ADDED: Full Screen Report Viewer Overrides --- */
        /* When report is active, make container full-width and remove padding */
        #appContainer:has(#page-report-viewer.active) {
            max-width: none;
            padding-left: 0;
            padding-right: 0;
            padding-bottom: 0; /* Remove bottom padding */
            overflow: hidden; /* Prevent inner scroll */
        }
        /* When report is active, make iframe edge-to-edge */
        #appContainer:has(#page-report-viewer.active) .report-iframe-wrapper {
            border-radius: 0;
            border: none;
            box-shadow: none;
        }
        /* When report is active, add responsive padding back to header */
        @media (min-width: 768px) {
            #appContainer:has(#page-report-viewer.active) .report-viewer-header {
                 padding-left: 2rem;
                 padding-right: 2rem;
            }
        }
        /* --- End Full Screen Report Viewer Overrides --- */


    </style>
</head>
<body>

    <!-- Updated Full Page Loader -->
    <div id="pageLoader" class="full-page-loader">
        <div id="loading-text-container">
            <span>Loading Dashboard...</span>
        </div>
    </div>

    <!-- Sticky Header -->
    <header id="appHeader" class="flex items-center justify-between">
        <h1 class="text-xl md:text-2xl font-bold text-gray-900">Fintech QC Dashboard</h1>
         <!-- Apply glassy-button style, icon only -->
        <button id="refresh-button" class="refresh-btn glassy-button">
            <i class="fas fa-sync-alt"></i>
            <span class="spinner"></span>
        </button>
    </header>

    <!-- Main Content Area -->
     <!-- Corrected container structure for full height -->
    <div id="appContainer" class="flex flex-col flex-grow">
        <!-- Error State (Moved near top) -->
        <div id="error-message" class="bg-red-100 border border-red-400 text-red-700 px-4 py-4 rounded-lg relative my-6 hidden flex-shrink-0" role="alert">
            <strong class="font-bold">Error: </strong>
            <span class="block sm:inline" id="error-text"></span>
        </div>

        <!--
        ====================================================================
        PAGE 1: Main Dashboard List
        ====================================================================
        -->
        <div id="page-dashboard" class="page active page-content">
            <!-- Dashboard Content Area -->
            <div id="dashboard-content" class="space-y-6">
                <!-- Content generated by JS -->
                <div class="text-center p-12 text-gray-500">Building dashboard...</div>
            </div>
        </div>

        <!--
        ====================================================================
        PAGE 2: Report Viewer
        ====================================================================
        -->
        <div id="page-report-viewer" class="page page-content" style="display: none;">
             <!-- Corrected inner container for flex grow - REMOVED h-full -->
            <div class="report-viewer-inner-container flex flex-col flex-grow" style="min-height: 0;">
                <!-- Header with Back Button -->
                <div class="report-viewer-header flex-shrink-0">
                     <!-- Apply glassy-button style, icon only -->
                    <button id="back-to-dashboard-button" class="back-button glassy-button">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <h2 id="report-title" class="text-xl font-semibold text-gray-700 truncate text-right ml-4">
                        Loading Report...
                    </h2>
                </div>

                <!-- Iframe Wrapper -->
                <div id="iframe-wrapper" class="report-iframe-wrapper">
                    <div class="iframe-loader text-center p-12">
                        <div class="spinner border-[var(--card-border)] border-t-[var(--accent-color)] w-12 h-12 animate-spin mx-auto"></div>
                        <p class="mt-4 text-[var(--text-muted-color)]">Loading report content...</p>
                    </div>
                    <iframe id="report-iframe" class="report-iframe hidden" src="about:blank"
                            sandbox="allow-scripts allow-same-origin allow-popups allow-forms">
                    </iframe>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer id="appFooter">
            Fintech QC Dashboard - Internal Tool
        </footer>
    </div>


    <script>
        // --- Configuration ---
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxP0LkTYhkky8p2w0dOmmCIj01aYnurgT2JBV00Pp6kWlY-j-g8JdXAldyvAIqkddw/exec";

        // --- DOM Elements ---
        const pageLoader = document.getElementById('pageLoader');
        const appHeader = document.getElementById('appHeader'); // Header element
        const appContainer = document.getElementById('appContainer');
        const pageDashboard = document.getElementById('page-dashboard');
        const pageReportViewer = document.getElementById('page-report-viewer');
        const errorMessage = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        const dashboardContent = document.getElementById('dashboard-content');
        const refreshButton = document.getElementById('refresh-button');
        // const refreshText = document.getElementById('refresh-text'); // Removed
        const refreshSpinner = refreshButton.querySelector('.spinner');
        const backToDashboardButton = document.getElementById('back-to-dashboard-button');
        const reportTitle = document.getElementById('report-title');
        const iframeWrapper = document.getElementById('iframe-wrapper');
        const iframeLoader = iframeWrapper.querySelector('.iframe-loader');
        const reportIframe = document.getElementById('report-iframe');

        let bookStructure = [];
        let qcSummaries = {};

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
             if (WEB_APP_URL === "PASTE_YOUR_DEPLOYED_WEB_APP_URL_HERE") {
                showError("Configuration Error: WEB_APP_URL is not set. Please edit this file.");
                hideLoader();
                return;
            }
            loadData();
        });

        refreshButton.addEventListener('click', loadData);
        backToDashboardButton.addEventListener('click', showDashboardPage);

        // --- Page Navigation ---
        function showDashboardPage() {
            pageReportViewer.style.display = 'none';
             pageReportViewer.classList.remove('active'); // Ensure active class is removed
            pageDashboard.style.display = 'block';
             pageDashboard.classList.add('active'); // Add active class
            appHeader.style.display = 'flex'; // Use flex for header
            document.body.style.paddingTop = 'var(--header-height)'; // <<< ADDED: Restore body padding
            reportIframe.removeEventListener('load', handleIframeLoad);
            reportIframe.srcdoc = '';
            reportIframe.src = 'about:blank';
            reportIframe.classList.add('hidden');
            iframeLoader.style.display = 'flex';
        }

        // --- Helper to Decode HTML Entities ---
        function decodeHtmlEntities(text) {
             if (typeof text !== 'string') return '';
            const textarea = document.createElement('textarea');
            textarea.innerHTML = text;
            return textarea.value;
        }

        // --- Iframe Load Handler (Refined) ---
        function handleIframeLoad() {
            console.log("Iframe 'load' event triggered");
            // Use a small delay to ensure contentDocument is accessible
            setTimeout(() => {
                try {
                    const iframeWin = reportIframe.contentWindow;
                    const iframeDoc = reportIframe.contentDocument || iframeWin?.document;

                    if (!iframeDoc) {
                        console.error("Could not access iframe document after load and delay.");
                        iframeLoader.innerHTML = `<div class="p-4 text-center"><p class="text-red-500 font-bold">Error: Could not access report content document.</p></div>`;
                        reportIframe.classList.add('hidden');
                        return;
                    }

                    // Attach click listeners to internal anchor links
                    const internalLinks = iframeDoc.querySelectorAll('a[href^="#"]');
                    console.log(`Found ${internalLinks.length} internal links inside iframe.`);

                    internalLinks.forEach(link => {
                        link.addEventListener('click', (event) => {
                            event.preventDefault();
                            event.stopPropagation();

                            const href = link.getAttribute('href');
                            console.log(`Internal link clicked: ${href}`);
                            if (href && href.length > 1) {
                                const targetId = href.substring(1);
                                const targetElement = iframeDoc.getElementById(targetId);
                                if (targetElement) {
                                    console.log(`Scrolling to element: #${targetId}`);
                                    targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                } else {
                                    console.warn(`Target element not found in iframe: #${targetId}`);
                                }
                            }
                        }, false);
                    });

                    // Hide loader and show iframe after setup
                    iframeLoader.style.display = 'none';
                    reportIframe.classList.remove('hidden');
                    console.log("Iframe navigation setup complete.");

                } catch (error) {
                    console.error("Error setting up iframe navigation:", error);
                    iframeLoader.innerHTML = `<div class="p-4 text-center"><p class="text-red-500 font-bold">Error initializing report view: ${error.message}</p></div>`;
                    reportIframe.classList.add('hidden');
                }
            }, 100); // Small delay (e.g., 100ms)
        }


        function showReportPage(fileId, title) {
            pageDashboard.style.display = 'none';
             pageDashboard.classList.remove('active'); // Remove active class
            pageReportViewer.style.display = 'flex'; // Use flex for this page
             pageReportViewer.classList.add('active'); // Add active class
            appHeader.style.display = 'none'; // Use display none
            document.body.style.paddingTop = '0'; // <<< ADDED: Remove body padding

            const decodedTitle = decodeHtmlEntities(title);
            reportTitle.textContent = `Report: ${decodedTitle}`;

            iframeLoader.style.display = 'flex';
            iframeLoader.innerHTML = ` <div class="text-center p-12">
                                        <div class="spinner border-[var(--card-border)] border-t-[var(--accent-color)] w-12 h-12 animate-spin mx-auto"></div>
                                        <p class="mt-4 text-[var(--text-muted-color)]">Loading report content...</p>
                                    </div>`; // Reset loader text and style
            reportIframe.classList.add('hidden');
            reportIframe.srcdoc = '';
            reportIframe.removeEventListener('load', handleIframeLoad);

            fetch(`${WEB_APP_URL}?action=getReportContent&fileId=${fileId}&cachebust=${new Date().getTime()}`)
                .then(async (res) => {
                    if (!res.ok) {
                        let errorBody = await res.text();
                        try {
                             const errJson = JSON.parse(errorBody);
                             throw new Error(errJson.message || `Fetch failed: ${res.status}`);
                         } catch(e) {
                             throw new Error(`Fetch failed: ${res.status} - ${errorBody || res.statusText}`);
                         }
                    }
                    const contentType = res.headers.get("content-type");
                    if (contentType && contentType.indexOf("application/json") !== -1) {
                         return res.json();
                    } else {
                         let text = await res.text();
                         throw new Error(`Unexpected response type: ${contentType}. Content: ${text.substring(0, 200)}...`);
                    }
                })
                .then(data => {
                    if (data.status === 'success' && data.html !== undefined) {
                        reportIframe.addEventListener('load', handleIframeLoad, { once: true });
                        reportIframe.srcdoc = data.html;
                        // Loader hiding is now handled in handleIframeLoad
                    } else {
                        throw new Error(data.message || 'Report HTML content missing in response.');
                    }
                })
                .catch(err => {
                    console.error('Report Load Error:', err);
                    iframeLoader.innerHTML = `<div class="p-4 text-center"><p class="text-red-500 font-bold">Error loading report: ${err.message}</p></div>`;
                    reportIframe.classList.add('hidden');
                    reportIframe.removeEventListener('load', handleIframeLoad);
                });
        }

        // --- Data Loading & Dashboard Building ---
        async function loadData() {
            setLoading(true);
            showError(null);

            try {
                const response = await fetch(`${WEB_APP_URL}?action=getDashboardData&cachebust=${new Date().getTime()}`);
                if (!response.ok) {
                     const errorText = await response.text();
                     if (errorText.includes("ScriptError")) throw new Error(`Apps Script Error. Check logs.`);
                     if (errorText.includes("Authorization needed")) throw newError(`Apps Script Authorization Error. Re-deploy.`);
                     throw new Error(`Server error (${response.status}): ${errorText || response.statusText}`);
                }
                const contentType = response.headers.get("content-type");
                 if (!contentType || !contentType.includes("application/json")) { // More flexible check
                    let text = await response.text();
                    throw new Error(`Expected JSON but received ${contentType}. Content: ${text.substring(0, 200)}...`);
                }

                const data = await response.json();
                console.log('Received data:', data);

                if (data.status === 'success') {
                    bookStructure = data.structure || [];
                    qcSummaries = data.summaries ? new Map(Object.entries(data.summaries)) : new Map();
                    console.log('Processed Book Structure:', bookStructure);
                    console.log('Processed QC Summaries Map:', qcSummaries);
                    buildDashboard();
                } else {
                    throw new Error(data.message || "Script returned error status.");
                }

            } catch (err) {
                 showError(`Failed to load data: ${err.message}.`);
                 dashboardContent.innerHTML = '';
                 console.error("Load Data Error:", err);
            } finally {
                setLoading(false);
                 hideLoader(); // Use hideLoader consistently
            }
        }

        // --- Loader Hide Function ---
        function hideLoader() {
             if (pageLoader && !pageLoader.classList.contains('hidden')) {
                 pageLoader.style.opacity = '0';
                 setTimeout(() => {
                     pageLoader.classList.add('hidden');
                     if (appContainer) appContainer.style.opacity = '1';
                 }, 500);
             } else if (appContainer) {
                 appContainer.style.opacity = '1';
             }
        }


         function buildDashboard() {
            if (bookStructure.length === 0) {
                dashboardContent.innerHTML = `<div class="text-center p-12 text-[var(--text-muted-color)] bg-[var(--sub-box-bg)] rounded-xl">No book structure found. Check Google Sheet tabs or run Apps Script sync if needed.</div>`;
                return;
            }

            let html = '';
            bookStructure.forEach((book, bookIndex) => {
                let moduleHtml = '';

                book.modules.forEach((module, moduleIndex) => {
                    let chapterHtml = '';
                    module.chapters.forEach((chapter) => {
                        const chapterStr = String(chapter || '');
                        const stableId = `${book.bookName}|${module.moduleName}|${chapterStr}`;
                        const summary = qcSummaries.get(stableId);

                        const statusClass = summary ? 'status-done' : 'status-pending';
                        const statusText = summary ? 'Done' : 'Pending'; // Shorter text
                        const errors = (summary?.TotalErrors === null || summary?.TotalErrors === undefined || summary?.TotalErrors === '') ? '-' : summary.TotalErrors;
                        const aiPercentValue = summary?.AIPercent;
                        const aiPercent = (aiPercentValue === null || aiPercentValue === undefined || aiPercentValue === '') ? '-' : `${parseFloat(aiPercentValue).toFixed(0)}%`; // No decimal for cleaner look
                         let lastUpdated = '-';
                         if (summary?.LastUpdated) {
                             try {
                                 const dateObj = new Date(summary.LastUpdated);
                                 if (!isNaN(dateObj.getTime())) {
                                     lastUpdated = dateObj.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }); // Shorter date
                                 } else { console.warn(`Invalid date format for ${stableId}: ${summary.LastUpdated}`) }
                             } catch (e) { console.warn(`Error parsing date for ${stableId}: ${summary.LastUpdated}`, e) }
                         }

                        const errorClass = summary && errors !== '-' && parseInt(errors) > 0 ? 'text-[var(--bad-text)] font-semibold' : 'text-[var(--text-muted-color)]'; // Use theme color
                        const aiClass = summary && aiPercent !== '-' && parseFloat(aiPercent) > 10 ? 'text-[var(--bad-text)] font-semibold' : 'text-[var(--text-muted-color)]'; // Use theme color

                        const reportFileID = summary?.ReportFileID;
                        const buttonHtml = (reportFileID && String(reportFileID).trim() !== '') ?
                             `<button data-fileid="${reportFileID}" data-title="${escapeHtml(chapterStr)}" class="view-report-button">View</button>`
                            : `<span class="no-report-span">N/A</span>`;

                        chapterHtml += `
                            <tr>
                                <td class="py-3 px-4 text-sm text-[var(--text-color)] font-medium">${escapeHtml(chapterStr)}</td>
                                <td class="py-3 px-4 text-center"> <span class="status-pill ${statusClass}">${statusText}</span> </td>
                                <td class="py-3 px-4 text-center text-sm ${errorClass}">${errors}</td>
                                <td class="py-3 px-4 text-center text-sm ${aiClass}">${aiPercent}</td>
                                <td class="py-3 px-4 text-center text-xs text-[var(--text-muted-color)]">${lastUpdated}</td> <!-- Smaller date font -->
                                <td class="py-3 px-4 text-center">${buttonHtml}</td>
                            </tr>
                        `;
                    });

                     moduleHtml += `
                        <div class="module-card">
                            <h3 class="module-header" data-target="module-content-${bookIndex}-${moduleIndex}">
                                <span class="module-title">${escapeHtml(module.moduleName)}</span>
                                <svg class="chevron h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"> <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /> </svg>
                            </h3>
                            <div id="module-content-${bookIndex}-${moduleIndex}" class="module-content">
                                <table class="chapter-table min-w-full">
                                    <thead>
                                        <tr>
                                            <th class="w-2/5 pl-4">Chapter</th> <!-- Align left -->
                                            <th class="w-[10%] text-center">Status</th>
                                            <th class="w-[10%] text-center">Errors</th>
                                            <th class="w-[10%] text-center">AI %</th>
                                            <th class="w-[15%] text-center">Last QC'd</th>
                                            <th class="w-[15%] text-center pr-4">Report</th> <!-- Align right -->
                                        </tr>
                                    </thead>
                                    <tbody style="background-color: var(--input-bg);">
                                        ${chapterHtml || '<tr><td colspan="6" class="text-center py-4 text-[var(--text-muted-color)]">No chapters found.</td></tr>'}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                });

                html += `
                    <div class="book-card">
                        <h2 class="book-header" data-target="book-content-${bookIndex}">
                            <span class="book-title">Book: ${escapeHtml(book.bookName)}</span>
                             <svg class="chevron h-6 w-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"> <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /> </svg>
                        </h2>
                        <div id="book-content-${bookIndex}" class="book-content space-y-4">
                            ${moduleHtml || '<div class="p-4 text-center text-[var(--text-muted-color)]">No modules found for this book.</div>'}
                        </div>
                    </div>
                `;
            });

            dashboardContent.innerHTML = html;
            attachAccordionListeners();
            attachViewReportListeners();
        }


        function attachAccordionListeners() {
            dashboardContent.querySelectorAll('.book-header, .module-header').forEach(header => {
                header.addEventListener('click', () => {
                    const targetId = header.getAttribute('data-target');
                    const content = document.getElementById(targetId);
                    const chevron = header.querySelector('.chevron');
                    if (content) {
                        const isOpen = content.classList.contains('open');
                        content.classList.toggle('open', !isOpen);
                        chevron?.classList.toggle('rotate-180', !isOpen);
                    }
                });
            });
            // Auto-open first book and first module if they exist
            const firstBookContent = dashboardContent.querySelector('.book-content');
            const firstBookHeader = dashboardContent.querySelector('.book-header');
            if (firstBookContent) firstBookContent.classList.add('open');
            if (firstBookHeader) firstBookHeader.querySelector('.chevron')?.classList.add('rotate-180');

            const firstModuleContent = firstBookContent?.querySelector('.module-content');
            const firstModuleHeader = firstBookContent?.querySelector('.module-header');
            if (firstModuleContent) firstModuleContent.classList.add('open');
            if (firstModuleHeader) firstModuleHeader.querySelector('.chevron')?.classList.add('rotate-180');
        }


        function attachViewReportListeners() {
            dashboardContent.querySelectorAll('.view-report-button').forEach(button => {
                button.addEventListener('click', () => {
                    const fileId = button.getAttribute('data-fileid');
                    const title = button.getAttribute('data-title');
                    if (fileId && fileId !== 'undefined' && fileId !== 'null' && String(fileId).trim() !== '') {
                        showReportPage(fileId, title);
                    } else {
                        console.error("View button clicked, but File ID is missing or invalid:", fileId, "Title:", title);
                        // Replaced alert with console error as alerts are problematic
                        console.error("Cannot view report: File ID is missing. Check the QC_Database sheet.");
                    }
                });
            });
        }

        // --- UI Helpers ---
        function escapeHtml(unsafe) {
             if (typeof unsafe !== 'string') {
                 try { unsafe = String(unsafe); } catch(e) { return ''; }
             }
             return unsafe
                  .replace(/&/g, "&amp;")
                  .replace(/</g, "&lt;")
                  .replace(/>/g, "&gt;")
                  .replace(/"/g, "&quot;")
                  .replace(/'/g, "&#039;");
         }
        function setLoading(isLoading) {
             refreshButton.disabled = isLoading;
             // Remove text update for icon-only button
             // refreshText.textContent = isLoading ? 'Refreshing...' : 'Refresh Data';
             refreshSpinner.style.display = isLoading ? 'inline-block' : 'none';
              // Hide icon when loading
             refreshButton.querySelector('i').style.display = isLoading ? 'none' : 'inline-block';
        }
        function showError(message) {
            if (message) {
                errorText.textContent = message;
                errorMessage.style.display = 'block';
            } else {
                errorMessage.style.display = 'none';
            }
        }
    </script>
</body>
</html>



